<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sistema de Designações - Congregação Veredas</title>
<title>Sistema de Designações – Desktop</title>
<script>

// Retorna chave mês YYYY-MM
function getMonthKey(dateObj) {
  const y = dateObj.getFullYear();
  const m = ('0' + (dateObj.getMonth() + 1)).slice(-2);
  return `${y}-${m}`;
}

const MAX_STREAK_BEFORE_REST = 3; // Trabalha 3 semanas, folga 1
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      window.location.href = "/mobile.html";
    }
  
// Função que coleta os dias marcados a partir dos CHECKBOXES de grupo (Principal e Adicional)
function getDiasSelecionados() {
  const dias = [];
  // Quinta (4) + Domingo (0)
  if (document.getElementById('day-group-principal')?.checked) {
    dias.push(4, 0);
  }
  // Quarta (3) + Sábado (6)
  if (document.getElementById('day-group-adicional')?.checked) {
    dias.push(3, 6);
  }
  return dias;
}

</script>
<!-- Bibliotecas Externas -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<!-- Removida a importação da biblioteca QRCode -->
<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
        /* Variáveis CSS */
        :root {
            --primary: #6a4eaf;
            --primary-light: #8c71d8;
            --secondary: #4e6aaf;
            --accent: #4eafaa;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 36px; /* aumento do tamanho */
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
            animation: titlePulse 4s ease-in-out infinite;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.8;
            margin-bottom: 0;
            position: relative;
            z-index: 2;
        }

        .header:before {
            content: "";
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: -100px;
            right: -50px;
            animation: floatCircle 12s ease-in-out infinite;
        }

        .header:after {
            content: "";
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            bottom: -50px;
            left: -50px;
        }

        /* Controles */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: space-between;
        }

        .filters, .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .select-container, .input-container {
            position: relative;
        }

        select, input, button, .btn {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            background-color: white;
            font-size: 14px;
            transition: var(--transition);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(106, 78, 175, 0.1);
        }

        .select-container select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .select-container:after {
            content: "\f078";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--primary);
            font-size: 14px;
        }

        .filter-active::after {
            color: #2ecc71;
        }

        .filter-active select {
            border-color: #2ecc71;
            font-weight: 500;
        }

        .filter-count {
            background: #f5f7fa;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            margin-left: 10px;
        }

        .btn {
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            background-color: var(--primary);
            color: white;
            border: none;
        }

        .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #5d7ac9;
        }

        .btn-accent {
            background-color: var(--accent);
        }

        .btn-accent:hover {
            background-color: #5eccc6;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #e95e50;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #40d47e;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #f4a62a;
        }

        .btn i {
            font-size: 14px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 4px;
        }

        /* Botão de exclusão em lote */
        #batch-delete-btn {
            background-color: var(--danger);
            margin-bottom: 10px;
            display: none;
        }

        /* Tabela */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 4px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
         font-size: 16px;}

        tr:hover {
            background-color: rgba(106, 78, 175, 0.05);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .edit-btn {
            color: var(--secondary);
        }

        .delete-btn {
            color: var(--danger);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* Checkboxes para seleção múltipla */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .designation-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Dias da semana coloridos */
        .day-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
            margin-left: 8px;
        }

        .day-quinta {
            background-color: #2196F3; /* Azul */
        }

        .day-domingo {
            background-color: #9C27B0; /* Roxo */
        }

        .day-quarta {
            background-color: #4CAF50; /* Verde */
        }

        .day-sabado {
            background-color: #FF9800; /* Laranja */
        }

        .day-segunda {
            background-color: #795548; /* Marrom */
        }

        .day-terca {
            background-color: #607D8B; /* Azul-cinza */
        }

        .day-sexta {
            background-color: #E91E63; /* Rosa */
        }

        .day-default {
            background-color: #9E9E9E; /* Cinza */
        }

        /* Indicadores visuais de status para designações */
        .date-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .function-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .function-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e3f2fd;
        }

        .function-indicator.estudo {
            background-color: #2e7d32;
        }

        .function-indicator.sentinela {
            background-color: #f57c00;
        }

        .function-indicator.microfone {
            background-color: #0277bd;
        }

        .function-indicator.indicador {
            background-color: #c2185b;
        }

        .function-indicator.operador {
            background-color: #7b1fa2;
        }

        .function-indicator.ajudante {
            background-color: #00695c;
        }

        /* Modal Base Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-large {
            max-width: 1200px;
            height: 90vh;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        /* Headers universais para todos os modais */
        .modal-header {
            background: linear-gradient(135deg, #7c4dff, #536dfe);
            color: white;
            padding: 24px;
            border-bottom: none;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        .modal-header::before {
            content: "";
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: -50px;
            right: -30px;
        }

        .modal-header h3 {
            color: white;
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header .modal-icon {
            font-size: 24px;
            opacity: 0.9;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 3;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 16px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-shrink: 0;
        }

        /* Modal de confirmação */
        #confirmation-modal .modal-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        #confirmation-modal .modal-header h3::before {
            content: "\f071";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
        }

        /* Tabela do modal de irmãos */
        #brothers-table {
            margin: 0;
        }

        #brothers-table thead {
            background: #f8f9fa;
        }

        #brothers-table th {
            background: #f8f9fa;
            color: #6c757d;
            font-weight: 600;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 16px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        #brothers-table td {
            padding: 16px 12px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f3f4;
        }

        #brothers-table tr:last-child td {
            border-bottom: none;
        }

        /* Avatar na tabela */
        .brother-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c4dff, #536dfe);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .brother-info {
            display: flex;
            align-items: center;
        }

        .brother-details h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 500;
            color: #212529;
        }

        .brother-contact {
            font-size: 13px;
            color: #6c757d;
            margin-top: 2px;
        }

        /* Tags das funções */
        .function-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .function-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .function-tag.estudo {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .function-tag.sentinela {
            background: #fff3e0;
            color: #f57c00;
        }

        .function-tag.indicador {
            background: #fce4ec;
            color: #c2185b;
        }

        .function-tag.microfone {
            background: #e1f5fe;
            color: #0277bd;
        }

        .function-tag.operador {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .function-tag.ajudante {
            background: #e0f2f1;
            color: #00695c;
        }

        /* Status badge */
        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-available {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-available::before {
            content: "●";
            color: #4caf50;
        }

        .status-unavailable {
            background-color: #ffebee;
            color: #c62828;
        }

        .status-unavailable::before {
            content: "●";
            color: #f44336;
        }

        /* Botões de ação no modal */
        #brothers-table .table-actions {
            justify-content: center;
        }

        #brothers-table .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        #brothers-table .edit-btn {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        #brothers-table .edit-btn:hover {
            background-color: #1976d2;
            color: white;
        }

        #brothers-table .delete-btn {
            background-color: #ffebee;
            color: #d32f2f;
        }

        #brothers-table .delete-btn:hover {
            background-color: #d32f2f;
            color: white;
        }

        /* Container da tabela com scroll */
        #manage-brothers-modal .table-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #manage-brothers-modal .table-responsive {
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 200px);
        }

        /* Formulários melhorados */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 14px;
            transition: var(--transition);
            background-color: #fff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Estilos melhorados para funções */
        .functions-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-start;
        }

        /* NOVO: Checkboxes coloridos das funções */
        .checkbox-group-improved {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .checkbox-item-improved {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: white;
            border: 1px solid #e9ecef;
        }

        .checkbox-item-improved:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Cores específicas para cada função (NOVO) */
        .checkbox-item-improved.function-estudo {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border-color: #4caf50;
        }

        .checkbox-item-improved.function-sentinela {
            background: linear-gradient(135deg, #fff3e0, #fef7ed);
            border-color: #ff9800;
        }

        .checkbox-item-improved.function-microfone {
            background: linear-gradient(135deg, #e3f2fd, #f3f9ff);
            border-color: #2196f3;
        }

        .checkbox-item-improved.function-indicador {
            background: linear-gradient(135deg, #fce4ec, #fef4f7);
            border-color: #e91e63;
        }

        .checkbox-item-improved.function-operador {
            background: linear-gradient(135deg, #f3e5f5, #faf5fc);
            border-color: #9c27b0;
        }

        .checkbox-item-improved.function-ajudante {
            background: linear-gradient(135deg, #e0f2f1, #f0f9ff);
            border-color: #009688;
        }

        .checkbox-item-improved input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item-improved label {
            cursor: pointer;
            font-weight: 400;
            color: var(--text-primary);
            user-select: none;
            margin: 0;
            font-size: 14px;
        }

        .checkbox-item-improved input:checked + label {
            font-weight: 500;
            color: var(--primary);
        }

        .checkbox-item-improved input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Modal de geração automática - CORRIGIDO */
        .days-selection-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .days-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .days-option:hover {
            border-color: var(--primary);
            background-color: rgba(124, 77, 255, 0.05);
        }

        .days-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .days-option label {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            user-select: none;
            margin: 0;
            font-size: 14px;
        }

        .days-option input:checked + label {
            color: var(--primary);
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background-color: rgba(124, 77, 255, 0.05);
            border-color: var(--primary);
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
            user-select: none;
            margin: 0;
        }

        /* Alertas melhorados */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid;
        }

        .alert i {
            font-size: 20px;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), rgba(46, 204, 113, 0.05));
            color: var(--success);
            border-left-color: var(--success);
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0.05));
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(243, 156, 18, 0.05));
            color: var(--warning);
            border-left-color: var(--warning);
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
            backdrop-filter: blur(4px);
        }

        .loading-text {
            margin-top: 15px;
            font-size: 18px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

         .toast {
            padding: 15px 20px;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease forwards;
            max-width: 350px;
            border-left: 4px solid;
        }

        .toast-success {
            border-left-color: var(--success);
        }

        .toast-error {
            border-left-color: var(--danger);
        }

        .toast-warning {
            border-left-color: var(--warning);
        }

        .toast-icon {
            font-size: 18px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .toast-close:hover {
            color: var(--danger);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Modal de impressão/exportação ATUALIZADO */
        .print-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .print-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .print-option:hover {
            border-color: var(--primary);
            background-color: rgba(124, 77, 255, 0.05);
        }

        .print-option.selected {
            border-color: var(--primary);
            background-color: rgba(124, 77, 255, 0.1);
        }

        .print-option i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .print-option h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        /* NOVO: Estilos para seleção de período */
        .period-selection {
            margin-bottom: 20px;
        }

        .period-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .period-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
        }

        .period-option:hover {
            border-color: var(--primary);
            background-color: rgba(124, 77, 255, 0.05);
        }

        .period-option.selected {
            border-color: var(--primary);
            background-color: rgba(124, 77, 255, 0.1);
            color: var(--primary);
        }

        .months-selection {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .months-selection.show {
            display: block;
        }

        .months-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .months-row label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 100px;
        }

        .months-row select {
            flex: 1;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filters, .actions {
                flex-direction: column;
                width: 100%;
            }
            .select-container, select, input, button, .btn {
                width: 100%;
            }
            .table-responsive {
                overflow-x: auto;
            }
            th, td {
                min-width: 120px;
            }
            .checkbox-group-improved {
                grid-template-columns: 1fr;
            }
            .modal {
                width: 95%;
                margin: 10px;
            }
            .modal-header {
                padding: 20px;
            }
            .modal-body {
                padding: 20px;
            }
            .period-options {
                flex-direction: column;
            }
            .months-row {
                flex-direction: column;
                align-items: stretch;
            }
            .months-row label {
                min-width: auto;
                margin-bottom: 5px;
            }
        }

        /* Estilos para Modal de Geração Automática Melhorado */
        .form-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .toggle-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toggle-btn:hover {
            background: #5eccc6;
            transform: translateY(-1px);
        }

        /* Campos de Data Melhorados */
        .date-inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .date-input-wrapper {
            position: relative;
            cursor: pointer;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            background: white;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-input-wrapper:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 78, 175, 0.1);
        }

        .date-input-wrapper input[type="date"] {
            border: none;
            background: transparent;
            padding: 0;
            font-size: 14px;
            flex: 1;
            cursor: pointer;
        }

        .date-input-wrapper input[type="date"]:focus {
            outline: none;
        }

        .date-icon {
            color: var(--primary);
            font-size: 16px;
        }

        /* Dias Simplificados */
        .days-selection-simplified {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .day-group-simplified {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .day-option-grouped {
            position: relative;
            padding: 16px;
        }

        .day-option-grouped input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .day-option-grouped label {
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: var(--transition);
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .day-option-grouped input[type="checkbox"]:checked + label {
            border-color: var(--primary);
            background: rgba(106, 78, 175, 0.05);
        }

        .day-option-grouped label:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .day-group-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .day-group-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .day-group-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .day-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .day-group-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .day-options {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .day-option-card {
            position: relative;
        }

        .day-option-card input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .day-option-card label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .day-option-card input[type="checkbox"]:checked + label {
            border-color: var(--primary);
            background: rgba(106, 78, 175, 0.05);
        }

        .day-option-card label:hover {
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .day-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .day-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Grid de Funções */
        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .function-card {
            position: relative;
        }

        .function-card input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .function-card label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            height: 100%;
        }

        .function-card input[type="checkbox"]:checked + label {
            border-color: var(--primary);
            background: rgba(106, 78, 175, 0.05);
        }

        .function-card label:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .function-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .function-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .function-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .function-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Grid de Configurações */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .setting-card {
            position: relative;
        }

        .setting-card input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .setting-card label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            height: 100%;
        }

        .setting-card input[type="checkbox"]:checked + label {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.05);
        }

        .setting-card label:hover {
            border-color: var(--success);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .setting-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .setting-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .setting-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .setting-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .date-inputs-row {
                grid-template-columns: 1fr;
            }
            
            .day-options {
                grid-template-columns: 1fr;
            }
            
            .functions-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    
/* Correção de espaço entre o texto e a seta nos selects */
.select-container select {
    padding-right: 35px;
}

.select-container:after {
    right: 12px;
}


        /* animação suave de “pulso” no título */
        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50%      { transform: scale(1.1); }
        }

        /* animação da bola de fundo */
        @keyframes floatCircle {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50%      { transform: translate(-30px, 20px) scale(1.05); }
        }

        .header .version {
            position: absolute;
            bottom: 12px;
            right: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            z-index: 2;
        }

        .table-container {
            width: 98%;
            margin: 0 auto 20px;
        }
</style>
</head>
<body>
<!-- Header -->
<div class="container">
<header class="header">
<h1>Sistema de Designações</h1>
<p>Congregação Veredas</p>

    <span class="version">V. 2.0</span>
</header>
<!-- Controles (Filtros e Botões) -->
<div class="controls">
<div class="filters">
<div class="select-container">
<select id="filter-month">
<option value="">Todos os meses</option>
<option value="0">Janeiro</option>
<option value="1">Fevereiro</option>
<option value="2">Março</option>
<option value="3">Abril</option>
<option value="4">Maio</option>
<option value="5">Junho</option>
<option value="6">Julho</option>
<option value="7">Agosto</option>
<option value="8">Setembro</option>
<option value="9">Outubro</option>
<option value="10">Novembro</option>
<option value="11">Dezembro</option>
</select>
</div>
<div class="select-container">
<select id="filter-function">
<option value="">Todas as funções</option>
<option value="Leitor Estudo Bíblico">Leitor Estudo Bíblico</option>
<option value="Leitor Sentinela">Leitor Sentinela</option>
<option value="Microfone 1">Microfone 1</option>
<option value="Microfone 2">Microfone 2</option>
<option value="Indicador Auditório">Indicador Auditório</option>
<option value="Indicador de Entrada">Indicador de Entrada</option>
<option value="Operador de Áudio">Operador de Áudio</option>
<option value="Ajudante do Operador">Ajudante do Operador</option>
</select>
</div>
<div class="select-container">
<select id="filter-brother">
<option value="">Todos os irmãos</option>
<!-- Será preenchido via JavaScript -->
</select>
</div>
<div class="filter-count" id="filter-count">0 designação(ões) encontrada(s)</div>
</div>
<div class="actions">
<button class="btn" id="btn-new-designation">
<i class="fas fa-plus"></i> Nova Designação
                </button>
<button class="btn btn-success" id="btn-auto-generate">
<i class="fas fa-magic"></i> Geração Automática
                </button>
<button class="btn btn-secondary" id="btn-new-brother">
<i class="fas fa-user-plus"></i> Novo Irmão
                </button>
<button class="btn btn-accent" id="btn-manage-brothers">
<i class="fas fa-users"></i> Gerenciar Irmãos
                </button>
<button class="btn btn-warning" id="btn-export-pdf">
<i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
<button class="btn btn-warning" id="btn-print-list">
<i class="fas fa-print"></i> Lista para Impressão
                </button>
<button class="btn btn-warning" id="btn-backup">
<i class="fas fa-download"></i> Backup
                </button>
<button class="btn btn-warning" id="btn-import">
<i class="fas fa-upload"></i> Importar JSON
                </button>
<button class="btn btn-success" id="btn-whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</button></div>
</div>
<!-- Botão de exclusão em lote -->
<button class="btn btn-danger" id="batch-delete-btn">
<i class="fas fa-trash-alt"></i> Excluir Selecionados
        </button>
<!-- Tabela de Designações -->
<div class="table-container">
<div class="table-responsive">
<table id="designations-table">
<thead>
<tr>
<th>
<div class="checkbox-wrapper">
<input aria-label="Selecionar todas as designações" class="designation-checkbox" id="select-all-designations" type="checkbox"/>
<label for="select-all-designations"></label>
</div>
</th>
<th>Data</th>
<th>Função</th>
<th>Irmão</th>
<th>Observações</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="designations-body">
<!-- Será preenchido via JavaScript -->
</tbody>
</table>
</div>
<div class="empty-state-wrapper" id="empty-state" style="display: flex; align-items: center; justify-content: center; height: 300px;">
<div class="empty-state">
<i class="fas fa-calendar-times"></i>
<h3>Nenhuma designação encontrada</h3>
<p>Adicione novas designações ou ajuste os filtros.</p>
</div>
</div>
</div>
<!-- Modal de Nova Designação -->
<div class="modal-overlay" id="designation-modal">
<div class="modal">
<div class="modal-header">
<h3 id="modal-title">Nova Designação</h3>
<button class="modal-close">Fechar</button>
</div>
<div class="modal-body">
<form id="designation-form">
<input id="designation-id" type="hidden"/>
<div class="form-group">
<label for="designation-date">Data:</label>
<input id="designation-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="designation-function">Função:</label>
<select id="designation-function" required="">
<option value="">Selecione uma função</option>
<option value="Leitor Estudo Bíblico">Leitor Estudo Bíblico</option>
<option value="Leitor Sentinela">Leitor Sentinela</option>
<option value="Microfone 1">Microfone 1</option>
<option value="Microfone 2">Microfone 2</option>
<option value="Indicador Auditório">Indicador Auditório</option>
<option value="Indicador de Entrada">Indicador de Entrada</option>
<option value="Operador de Áudio">Operador de Áudio</option>
<option value="Ajudante do Operador">Ajudante do Operador</option>
</select>
</div>
<div class="form-group">
<label for="designation-brother">Irmão:</label>
<select id="designation-brother" required="">
<option value="">Selecione um irmão</option>
<!-- Será preenchido via JavaScript -->
</select>
</div>
<div class="form-group">
<label for="designation-observations">Observações:</label>
<textarea id="designation-observations" placeholder="Digite observações adicionais..."></textarea>
</div>
<div class="form-group">
<div class="checkbox-item-improved">
<input id="designation-notificacao" type="checkbox"/>
<label for="designation-notificacao">Notificar irmão?</label>
</div>
</div></form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">Fechar</button>
<button class="btn" id="btn-save-designation">Salvar</button>
</div>
</div>
</div>
<!-- Modal de Irmãos -->
<div class="modal-overlay" id="brother-modal">
<div class="modal">
<div class="modal-header">
<h3 id="brother-modal-title">Novo Irmão</h3>
<button class="modal-close">Fechar</button>
</div>
<div class="modal-body">
<form id="brother-form">
<input id="brother-id" type="hidden"/>
<div class="form-group">
<label for="brother-name">Nome completo:</label>
<input id="brother-name" placeholder="Digite o nome completo" required="" type="text"/>
</div>
<div class="form-group">
<label for="brother-phone">Telefone:</label>
<input id="brother-phone" placeholder="(44) 99999-9999" type="tel"/>
</div>
<div class="form-group">
<label for="brother-email">E-mail:</label>
<input id="brother-email" placeholder="exemplo@email.com" type="email"/>
</div>
<div class="form-group">
<label>Funções que pode exercer:</label>
<div class="functions-header">
<button class="btn btn-secondary btn-small" id="toggle-all-functions" type="button">
<i class="fas fa-check-square"></i> Marcar Todos
                            </button>
</div>
<div class="checkbox-group-improved">
<div class="checkbox-item-improved function-estudo">
<input aria-label="Leitor Estudo Bíblico" id="function-eb" type="checkbox" value="Leitor Estudo Bíblico"/>
<label for="function-eb">Leitor Estudo Bíblico</label>
</div>
<div class="checkbox-item-improved function-sentinela">
<input aria-label="Leitor Sentinela" id="function-sentinela" type="checkbox" value="Leitor Sentinela"/>
<label for="function-sentinela">Leitor Sentinela</label>
</div>
<div class="checkbox-item-improved function-microfone">
<input aria-label="Microfone" id="function-microfone" type="checkbox" value="Microfone"/>
<label for="function-microfone">Microfone</label>
</div>
<div class="checkbox-item-improved function-indicador">
<input aria-label="Indicador" id="function-indicador" type="checkbox" value="Indicador"/>
<label for="function-indicador">Indicador</label>
</div>
<div class="checkbox-item-improved function-operador">
<input aria-label="Operador de Áudio" id="function-audio" type="checkbox" value="Operador de Áudio"/>
<label for="function-audio">Operador de Áudio</label>
</div>
<div class="checkbox-item-improved function-ajudante">
<input aria-label="Ajudante do Operador" id="function-assistant" type="checkbox" value="Ajudante do Operador"/>
<label for="function-assistant">Ajudante do Operador</label>
</div>
</div>
</div>
<div class="form-group">
<div class="checkbox-item-improved">
<input aria-label="Disponível para designações" checked="" id="brother-available" type="checkbox"/>
<label for="brother-available">Disponível para designações</label>
</div>
</div>
<div class="form-group">
<label for="brother-observations">Observações:</label>
<textarea id="brother-observations" placeholder="Digite observações sobre o irmão..."></textarea>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">Fechar</button>
<button class="btn" id="btn-save-brother">Salvar</button>
</div>
</div>
</div>
<!-- Modal de Gerenciamento de Irmãos -->
<div class="modal-overlay" id="manage-brothers-modal">
<div class="modal modal-large">
<div class="modal-header">
<div>
<h3>Lista de Irmãos</h3>
<div class="brothers-stats">
<span class="brothers-count" id="brothers-count">0 irmãos cadastrados</span>
<span class="available-count" id="available-count">0 disponíveis</span>
</div>
</div>
<button class="modal-close">Fechar</button>
</div>
<div class="modal-body">
<div class="table-container">
<div class="table-responsive">
<table id="brothers-table">
<thead>
<tr>
<th>NOME</th>
<th>CONTATO</th>
<th>FUNÇÕES</th>
<th>STATUS</th>
<th>AÇÕES</th>
</tr>
</thead>
<tbody id="brothers-body">
<!-- Será preenchido via JavaScript -->
</tbody>
</table>
</div>
<div class="empty-state" id="brothers-empty-state">
<i class="fas fa-users"></i>
<h3>Nenhum irmão cadastrado</h3>
<p>Cadastre novos irmãos para começar a usar o sistema.</p>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn" id="btn-add-brother-from-manage">
<i class="fas fa-plus"></i> Adicionar Irmão
                </button>
<button class="btn btn-secondary modal-close">Fechar</button>
</div>
</div>
</div>
<!-- Modal Geração Automática - VERSÃO MELHORADA -->
<div class="modal-overlay" id="auto-generate-modal">
<div class="modal">
<div class="modal-header">
<h3><i class="fas fa-magic modal-icon"></i> Geração Automática de Designações</h3>
<button class="modal-close"></button>
</div>
<div class="modal-body">
<!-- Seção de Datas Melhorada -->
<div class="form-section">
<h4 class="section-title">
<i class="fas fa-calendar-alt"></i> Período das Designações
</h4>
<div class="date-inputs-row">
<div class="date-input-group">
<label for="auto-start-date">Data de início:</label>
<div class="date-input-wrapper" onclick="document.getElementById('auto-start-date').showPicker()">
<input id="auto-start-date" required="" type="date"/>
<i class="fas fa-calendar-day date-icon"></i>
</div>
</div>
<div class="date-input-group">
<label for="auto-end-date">Data de fim:</label>
<div class="date-input-wrapper" onclick="document.getElementById('auto-end-date').showPicker()">
<input id="auto-end-date" required="" type="date"/>
<i class="fas fa-calendar-day date-icon"></i>
</div>
</div>
</div>
</div>
<!-- Seção de Dias Simplificada -->
<div class="form-section">
<div class="section-header">
<h4 class="section-title">
<i class="fas fa-clock"></i> Dias das Reuniões
</h4>
<button class="toggle-btn" id="toggle-all-days" type="button">
<i class="fas fa-check-square"></i> Marcar Todos
</button>
</div>
<div class="days-selection-simplified">
<div class="day-group-simplified primary-meetings">
<div class="day-group-header">
<i class="fas fa-star"></i>
<span>Reuniões 2025</span>
</div>
<div class="day-option-grouped">
<input checked="" id="day-group-principal" type="checkbox" value="principal"/>
<label for="day-group-principal">
<i class="fas fa-calendar-week"></i>
<div class="day-group-info">
<span class="day-group-name">Quinta-feira + Domingo</span>
<span class="day-group-desc">Reuniões principais da semana</span>
</div>
</label>
</div>
</div>
<div class="day-group-simplified optional-meetings">
<div class="day-group-header">
<i class="fas fa-plus-circle"></i>
<span>Reuniões 2026</span>
</div>
<div class="day-option-grouped">
<input id="day-group-adicional" type="checkbox" value="adicional"/>
<label for="day-group-adicional">
<i class="fas fa-calendar-plus"></i>
<div class="day-group-info">
<span class="day-group-name">Quarta-feira + Sábado</span>
<span class="day-group-desc">Quando houver reunião</span>
</div>
</label>
</div>
</div>
</div>
</div>
<!-- Seção de Funções Melhorada -->
<div class="form-section" style="display:none;">
<div class="section-header">
<h4 class="section-title">
<i class="fas fa-users"></i> Funções a Gerar
</h4>
<div class="select-all-wrapper" style="display:flex;align-items:center;gap:6px;">
<input id="auto-func-select-all" style="width:18px;height:18px;cursor:pointer;accent-color:var(--primary);" type="checkbox"/>
<label for="auto-func-select-all" style="cursor:pointer;font-size:14px;font-weight:500;color:var(--text-primary);">Todos</label>
</div>
</div>
<div class="functions-grid">
<div class="function-card">
<input checked="" id="auto-func-indicador" type="checkbox" value="Indicador"/>
<label for="auto-func-indicador">
<div class="function-icon">
<i class="fas fa-hand-point-right"></i>
</div>
<div class="function-info">
<span class="function-name">Indicadores</span>
<span class="function-desc">2 por reunião</span>
</div>
</label>
</div>
<div class="function-card">
<input checked="" id="auto-func-microfone" type="checkbox" value="Microfone"/>
<label for="auto-func-microfone">
<div class="function-icon">
<i class="fas fa-microphone"></i>
</div>
<div class="function-info">
<span class="function-name">Microfones</span>
<span class="function-desc">2 por reunião</span>
</div>
</label>
</div>
<div class="function-card">
<input checked="" id="auto-func-som" type="checkbox" value="Som"/>
<label for="auto-func-som">
<div class="function-icon">
<i class="fas fa-volume-up"></i>
</div>
<div class="function-info">
<span class="function-name">Sistema de Som</span>
<span class="function-desc">Operador + Auxiliar</span>
</div>
</label>
</div>
<div class="function-card">
<input id="auto-func-leitores" type="checkbox" value="Leitores"/>
<label for="auto-func-leitores">
<div class="function-icon">
<i class="fas fa-book"></i>
</div>
<div class="function-info">
<span class="function-name">Leitores</span>
<span class="function-desc">Estudo Bíblico + Sentinela</span>
</div>
</label>
</div>
</div>
</div>
<!-- Seção de Configurações Melhorada -->
<div class="form-section" style="display:none;">
<div class="section-header">
<h4 class="section-title">
<i class="fas fa-cogs"></i> Configurações Avançadas
</h4>
<button class="toggle-btn" id="toggle-all-settings" type="button">
<i class="fas fa-check-square"></i> Alternar Todas
</button>
</div>
<div class="settings-grid">
<div class="setting-card">
<input checked="" id="auto-respect-availability" type="checkbox"/>
<label for="auto-respect-availability">
<div class="setting-icon">
<i class="fas fa-user-check"></i>
</div>
<div class="setting-info">
<span class="setting-name">Respeitar Disponibilidade</span>
<span class="setting-desc">Considerar apenas irmãos disponíveis</span>
</div>
</label>
</div>
<div class="setting-card">
<input checked="" id="auto-avoid-consecutive" type="checkbox"/>
<label for="auto-avoid-consecutive">
<div class="setting-icon">
<i class="fas fa-balance-scale"></i>
</div>
<div class="setting-info">
<span class="setting-name">Evitar Consecutivas</span>
<span class="setting-desc">Distribuição mais equilibrada</span>
</div>
</label>
</div>
<div class="setting-card">
<input checked="" id="auto-rotate-som" type="checkbox"/>
<label for="auto-rotate-som">
<div class="setting-icon">
<i class="fas fa-sync-alt"></i>
</div>
<div class="setting-info">
<span class="setting-name">Alternar Som</span>
<span class="setting-desc">Operador/Auxiliar no domingo</span>
</div>
</label>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">
<i class="fas fa-times"></i> Fechar
</button>
<button class="btn btn-success" id="btn-generate-auto">
<i class="fas fa-magic"></i> Gerar Designações
</button>
</div>
</div>
</div>
<!-- Modal de Lista para Impressão ATUALIZADO -->
<div class="modal-overlay" id="print-modal">
<div class="modal">
<div class="modal-header">
<h3><i class="fas fa-print modal-icon"></i> Lista para Impressão</h3>
<button class="modal-close"></button>
</div>
<div class="modal-body">
<div class="form-group">
<label>Selecione o tipo de lista:</label>
<div class="print-options">
<div class="print-option" data-type="leitores">
<i class="fas fa-book"></i>
<h4>Leitores</h4>
<p>Estudo Bíblico e Sentinela</p>
</div>
<div class="print-option" data-type="microfones">
<i class="fas fa-microphone"></i>
<h4>Microfones</h4>
<p>Microfone 1 e 2</p>
</div>
<div class="print-option" data-type="indicadores">
<i class="fas fa-hand-point-right"></i>
<h4>Indicadores</h4>
<p>Indicador Auditório e Indicador de Entrada</p>
</div>
<div class="print-option" data-type="som">
<i class="fas fa-volume-up"></i>
<h4>Sistema de Som</h4>
<p>Operador e Ajudante</p>
</div>
</div>
</div>
<!-- NOVO: Seleção de período -->
<div class="form-group period-selection">
<label>Período:</label>
<div class="period-options">
<div class="period-option selected" data-period="1">
<i class="fas fa-calendar-day"></i> 1 Mês
                        </div>
<div class="period-option" data-period="2">
<i class="fas fa-calendar-alt"></i> 2 Meses
                        </div>
</div>
</div>
<!-- Seleção para 1 mês -->
<div class="months-selection show" id="single-month-selection">
<div class="months-row">
<label for="print-month">Mês:</label>
<select id="print-month" required="">
<option value="">Selecione um mês</option>
<option value="0">Janeiro</option>
<option value="1">Fevereiro</option>
<option value="2">Março</option>
<option value="3">Abril</option>
<option value="4">Maio</option>
<option value="5">Junho</option>
<option value="6">Julho</option>
<option value="7">Agosto</option>
<option value="8">Setembro</option>
<option value="9">Outubro</option>
<option value="10">Novembro</option>
<option value="11">Dezembro</option>
</select>
</div>
<div class="months-row">
<label for="print-year">Ano:</label>
<select id="print-year" required="">
<!-- Será preenchido via JavaScript -->
</select>
</div>
</div>
<!-- Seleção para 2 meses -->
<div class="months-selection" id="double-month-selection">
<div class="months-row">
<label for="print-month1">Primeiro mês:</label>
<select id="print-month1" required="">
<option value="">Selecione o primeiro mês</option>
<option value="0">Janeiro</option>
<option value="1">Fevereiro</option>
<option value="2">Março</option>
<option value="3">Abril</option>
<option value="4">Maio</option>
<option value="5">Junho</option>
<option value="6">Julho</option>
<option value="7">Agosto</option>
<option value="8">Setembro</option>
<option value="9">Outubro</option>
<option value="10">Novembro</option>
<option value="11">Dezembro</option>
</select>
</div>
<div class="months-row">
<label for="print-month2">Segundo mês:</label>
<select id="print-month2" required="">
<option value="">Selecione o segundo mês</option>
<option value="0">Janeiro</option>
<option value="1">Fevereiro</option>
<option value="2">Março</option>
<option value="3">Abril</option>
<option value="4">Maio</option>
<option value="5">Junho</option>
<option value="6">Julho</option>
<option value="7">Agosto</option>
<option value="8">Setembro</option>
<option value="9">Outubro</option>
<option value="10">Novembro</option>
<option value="11">Dezembro</option>
</select>
</div>
<div class="months-row">
<label for="print-year2">Ano:</label>
<select id="print-year2" required="">
<!-- Será preenchido via JavaScript -->
</select>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">Fechar</button>
<button class="btn" id="btn-generate-print">
<i class="fas fa-print"></i> Gerar Lista
                </button>
</div>
</div>
</div>
<!-- Modal de Exportação PDF -->
<div class="modal-overlay" id="export-modal">
<div class="modal">
<div class="modal-header">
<h3>Exportar para PDF</h3>
<button class="modal-close">Fechar</button>
</div>
<div class="modal-body">
<div class="form-group">
<label>Tipo de Impressão:</label>
<select id="export-type">
<option value="weekly">Semanal</option>
<option value="monthly">Mensal</option>
<option value="board">Quadro de Anúncios</option>
</select>
</div>
<div class="form-group" id="export-weekly-container">
<label for="export-week">Semana:</label>
<input id="export-week" type="week"/>
</div>
<div class="form-group" id="export-monthly-container" style="display:none;">
<label for="export-month">Mês:</label>
<input id="export-month" type="month"/>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">Fechar</button>
<button class="btn" id="btn-export-confirm">Exportar</button>
</div>
</div>
</div>
<!-- Modal de Confirmação -->
<div class="modal-overlay" id="confirmation-modal">
<div class="modal">
<div class="modal-header">
<h3>Confirmação</h3>
</div>
<div class="modal-body">
<p id="confirmation-message">Tem certeza que deseja realizar esta ação?</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary modal-close">Fechar</button>
<button class="btn btn-danger" id="btn-confirm-action">Confirmar</button>
</div>
</div>
</div>
<!-- Importação JSON (Oculto) -->
<input accept="application/json" id="import-file" style="display:none;" type="file"/>
<!-- Overlay de carregamento -->
<div class="loading-overlay" id="loading-overlay" style="display:none;">
<div class="loader"></div>
<div class="loading-text">Carregando...</div>
</div>
<!-- Container de Notificações Toast -->
<div class="toast-container" id="toast-container"></div>
<script>
        // Configuração do Supabase
        const supabaseUrl = 'https://kuypzuyyolklxbimvjhr.supabase.co';
           const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1eXB6dXl5b2xrbHhiaW12amhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NDI0MTIsImV4cCI6MjA2MzMxODQxMn0.xEwo7UtTZWJYkxnuDakOJQflQnywLDWG7WXIEUDUwGU';
        
        // Aguardar o carregamento da biblioteca Supabase
        
        // Variáveis globais
        let designations = [];
        let brothers = [];

        
    // ========= Função para obter emoji da função =========
    function getFunctionEmoji(funcao) {
    const emojiMapping = {
        'Leitor Estudo Bíblico': '📘️',
        'Leitor Sentinela': '📘️',
        'Microfone 1': '🎤️',
        'Microfone 2': '🎤️',
        'Indicador Auditório': '🧍️',
        'Indicador de Entrada': '🧍️',
        'Operador de Áudio': '🎧️',
        'Ajudante do Operador': '🧑‍🔧️'
    };
            return emojiMapping[funcao] || '📋';
        }
    // =====================================================
    
// Funções de utilidades
        function showLoading(message = 'Carregando...') {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('.loading-text').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            switch(type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'exclamation-circle'; break;
                case 'warning': icon = 'exclamation-triangle'; break;
                default: icon = 'info-circle';
            }

            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close">&times;</button>
            `;

            toastContainer.appendChild(toast);

            // Add close functionality
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            });

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toastContainer.removeChild(toast);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function formatDate(dateString) {
            // dateString é "YYYY-MM-DD"
            return corrigirData(dateString).toLocaleDateString('pt-BR');
        }

        function corrigirData(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function getDayOfWeekInfo(dateString) {
            // dateString é "YYYY-MM-DD"
            const date = corrigirData(dateString);
            const dayOfWeek = date.getDay(); // 0=Domingo, 1=Segunda, ..., 6=Sábado
            
            const dayNames = {
                0: { name: 'DOMINGO', class: 'day-domingo' },
                1: { name: 'SEGUNDA', class: 'day-segunda' },
                2: { name: 'TERÇA', class: 'day-terca' },
                3: { name: 'QUARTA', class: 'day-quarta' },
                4: { name: 'QUINTA', class: 'day-quinta' },
                5: { name: 'SEXTA', class: 'day-sexta' },
                6: { name: 'SÁBADO', class: 'day-sabado' }
            };
            
            return dayNames[dayOfWeek] || { name: 'INDEFINIDO', class: 'day-default' };
        }

        // Verificar compatibilidade entre função da designação e funções do irmão
        function verificarCompatibilidadeFuncao(funcaoDesignacao, funcoesIrmao) {
            if (!funcoesIrmao || funcoesIrmao.length === 0) {
                console.log('Irmão não tem funções cadastradas');
                return false;
            }

            // Mapeamento de funções específicas para funções gerais
            const mapeamento = {
                'Microfone 1': 'Microfone',
                'Microfone 2': 'Microfone',
                'Indicador Auditório': 'Indicador',
                'Indicador de Entrada': 'Indicador'
            };

            // Se a função da designação tem um mapeamento, usar a função geral
            const funcaoParaVerificar = mapeamento[funcaoDesignacao] || funcaoDesignacao;
            
            console.log('Verificando compatibilidade:');
            console.log('- Função da designação:', funcaoDesignacao);
            console.log('- Função para verificar:', funcaoParaVerificar);
            console.log('- Funções do irmão:', funcoesIrmao);
            
            const compativel = funcoesIrmao.includes(funcaoParaVerificar);
            console.log('- Resultado:', compativel);
            
            return compativel;
        }

        // Função para obter classe CSS da função
        function getFunctionClass(funcao) {
            const mapping = {
                'Leitor Estudo Bíblico': 'estudo',
                'Leitor Sentinela': 'sentinela',
                'Microfone': 'microfone',
                'Microfone 1': 'microfone',
                'Microfone 2': 'microfone',
                'Indicador': 'indicador',
                'Indicador Auditório': 'indicador',
                'Indicador de Entrada': 'indicador',
                'Operador de Áudio': 'operador',
                'Ajudante do Operador': 'ajudante'
            };
            return mapping[funcao] || 'default';
        }

        // Carregamento de Dados
        async function loadBrothers() {
            try {
                showLoading('Carregando irmãos...');
                const { data, error } = await supabaseClient
                    .from('irmaos')
                    .select('*')
                    .order('nome');

                if (error) throw error;

                brothers = data || [];
                console.log('Irmãos carregados:', brothers);

                // Preencher o select de irmãos nos filtros
                const brotherSelect = document.getElementById('filter-brother');

                // Limpar as opções existentes do filtro
                while (brotherSelect.options.length > 1) {
                    brotherSelect.remove(1);
                }

                // Adicionar as opções de irmãos ao filtro
                brothers.forEach(brother => {
                    const option = document.createElement('option');
                    option.value = brother.id;
                    option.textContent = brother.nome;
                    brotherSelect.appendChild(option);
                });

                console.log(`${brothers.length} irmãos carregados`);

            } catch (error) {
                console.error('Erro ao carregar irmãos:', error);
                showToast('Erro ao carregar irmãos: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadDesignations() {
            try {
                showLoading('Carregando designações...');
                const { data, error } = await supabaseClient
                    .from('designacoes_final')
                    .select(`
                        *,
                        irmaos (
                            nome
                        )
                    `)
                    .order('data');

                if (error) throw error;

                designations = data || [];
                filterDesignations();
                
                console.log(`${designations.length} designações carregadas`);
            } catch (error) {
                console.error('Erro ao carregar designações:', error);
                showToast('Erro ao carregar designações: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Filtragem e exibição de designações
        function filterDesignations() {
            const monthFilter = document.getElementById('filter-month').value;
            const functionFilter = document.getElementById('filter-function').value;
            const brotherFilter = document.getElementById('filter-brother').value;

            let filtered = [...designations];

            if (monthFilter) {
                filtered = filtered.filter(d => {
                    const date = new Date(d.data + "T00:00:00");
                    return date.getMonth() === parseInt(monthFilter);
                });
            }

            if (functionFilter) {
                filtered = filtered.filter(d => d.funcao === functionFilter);
            }

            if (brotherFilter) {
                filtered = filtered.filter(d => d.irmao_id === brotherFilter);
            }

            // Adicionar classe visual ao filtro selecionado
            document.querySelectorAll('.select-container').forEach(container => {
                container.classList.remove('filter-active');
            });
            
            if (monthFilter) document.querySelector('#filter-month').parentNode.classList.add('filter-active');
            if (functionFilter) document.querySelector('#filter-function').parentNode.classList.add('filter-active');
            if (brotherFilter) document.querySelector('#filter-brother').parentNode.classList.add('filter-active');
            
            // Atualizar contagem de resultados
            const countText = `${filtered.length} designação(ões) encontrada(s)`;
            document.getElementById('filter-count').textContent = countText;

            displayDesignations(filtered);
        }

        function displayDesignations(designationsToShow) {
            const tbody = document.getElementById('designations-body');
            const emptyState = document.getElementById('empty-state');

            // Limpar a tabela
            tbody.innerHTML = '';

            if (designationsToShow.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            // Ordenar por data
            designationsToShow.sort((a, b) => new Date(a.data + "T00:00:00") - new Date(b.data + "T00:00:00"));

            // Preencher a tabela
            designationsToShow.forEach(designation => {
                const dayInfo = getDayOfWeekInfo(designation.data);
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="designation-${designation.id}" class="designation-checkbox" data-id="${designation.id}" aria-label="Selecionar designação">
                            <label for="designation-${designation.id}"></label>
                        </div>
                    </td>
                    <td>
                        <div class="date-display">
                            ${formatDate(designation.data)}
                            <span class="day-badge ${dayInfo.class}">${dayInfo.name}</span>
                        </div>
                    </td>
                    <td>
                        <div class="function-display">
                            <span class="function-indicator ${getFunctionClass(designation.funcao)}"></span>
                            ${designation.funcao}
                        </div>
                    </td>
                    <td>${designation.irmaos?.nome || 'N/A'}</td>
                    <td>${designation.observacoes || ''}</td>
                    <td class="table-actions">
                        <button class="action-btn edit-btn" data-id="${designation.id}" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${designation.id}" title="Excluir">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="action-btn whatsapp-btn" data-id="${designation.id}" title="Enviar mensagem via WhatsApp">
                            <i class="fab fa-whatsapp" style="color: #25D366;"></i>
                        </button>
                    </td>
                `;

                // Adicionar event listeners para os botões de ação
                tr.querySelector('.edit-btn').addEventListener('click', () => editDesignation(designation.id));
                tr.querySelector('.delete-btn').addEventListener('click', () => deleteDesignation(designation.id));
                tr.querySelector('.whatsapp-btn').addEventListener('click', () => sendDesignation(designation.id));

                tbody.appendChild(tr);
            });

            // Configurar evento para o checkbox "selecionar todos"
            setupSelectAllCheckbox();
        }

        // Configurar checkbox "selecionar todos"
        function setupSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all-designations');
            const designationCheckboxes = document.querySelectorAll('.designation-checkbox:not(#select-all-designations)');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');

            // Event listener para "selecionar todos"
            selectAllCheckbox.addEventListener('change', function() {
                designationCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBatchDeleteButton();
            });

            // Event listeners para checkboxes individuais
            designationCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedCount = document.querySelectorAll('.designation-checkbox:not(#select-all-designations):checked').length;
                    selectAllCheckbox.checked = checkedCount === designationCheckboxes.length;
                    selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < designationCheckboxes.length;
                    updateBatchDeleteButton();
                });
            });

            function updateBatchDeleteButton() {
                const checkedCount = document.querySelectorAll('.designation-checkbox:not(#select-all-designations):checked').length;
                if (checkedCount > 0) {
                    batchDeleteBtn.style.display = 'flex';
                    batchDeleteBtn.innerHTML = `<i class="fas fa-trash-alt"></i> Excluir Selecionados (${checkedCount})`;
                } else {
                    batchDeleteBtn.style.display = 'none';
                }
            }
        }

        // Gestão de modais
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // Função para filtrar irmãos baseado na função selecionada
        function updateBrotherOptions() {
            const funcaoSelecionada = document.getElementById('designation-function').value;
            const selectIrmao = document.getElementById('designation-brother');
            
            console.log('Atualizando opções de irmãos para função:', funcaoSelecionada);
            console.log('Irmãos disponíveis:', brothers);
            console.log('Total de irmãos:', brothers.length);
            
            // Limpar opções existentes, exceto a primeira
            while (selectIrmao.options.length > 1) {
                selectIrmao.remove(1);
            }
            
            if (!funcaoSelecionada) {
                // Se nenhuma função selecionada, mostrar todos os irmãos disponíveis
                brothers.filter(brother => brother.disponivel).forEach(brother => {
                    const option = document.createElement('option');
                    option.value = brother.id;
                    option.textContent = brother.nome;
                    selectIrmao.appendChild(option);
                });
                console.log('Mostrando todos os irmãos disponíveis');
            } else {
                // Mostrar apenas irmãos que podem exercer a função selecionada
                const irmaosCompativeis = brothers.filter(brother => {
                    if (!brother.disponivel) return false;
                    if (!brother.funcoes || brother.funcoes.length === 0) return false;
                    
                    // Verificar compatibilidade de função
                    return verificarCompatibilidadeFuncao(funcaoSelecionada, brother.funcoes);
                });
                
                console.log('Irmãos compatíveis encontrados:', irmaosCompativeis);
                
                if (irmaosCompativeis.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum irmão disponível para esta função';
                    option.disabled = true;
                    selectIrmao.appendChild(option);
                } else {
                    irmaosCompativeis.forEach(brother => {
                        const option = document.createElement('option');
                        option.value = brother.id;
                        option.textContent = brother.nome;
                        selectIrmao.appendChild(option);
                    });
                }
            }
            
            console.log('Opções de irmãos atualizadas. Total de opções:', selectIrmao.options.length);
        }

        // Manipulação de Designações
        function openNewDesignationModal() {
            // Limpar formulário
            document.getElementById('designation-form').reset();
            document.getElementById('designation-id').value = '';

            // Definir data para hoje
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('designation-date').value = formattedDate;

            // Alterar título do modal
            document.getElementById('modal-title').textContent = 'Nova Designação';

            // Carregar todos os irmãos disponíveis inicialmente
            updateBrotherOptions();

    document.getElementById('designation-date').focus();

            openModal('designation-modal');
        }

        async function editDesignation(id) {
            try {
                showLoading('Carregando designação...');

                const designation = designations.find(d => d.id === id);
                if (!designation) {
                    throw new Error('Designação não encontrada');
                }

                // Preencher formulário
                document.getElementById('designation-id').value = designation.id;
                document.getElementById('designation-date').value = designation.data;
                document.getElementById('designation-function').value = designation.funcao;
                
                // Atualizar lista de irmãos baseado na função
                updateBrotherOptions();
                
                // Definir o irmão selecionado
                document.getElementById('designation-brother').value = designation.irmao_id;
                document.getElementById('designation-observations').value = designation.observacoes || '';

                // Alterar título do modal
                document.getElementById('modal-title').textContent = 'Editar Designação';

                openModal('designation-modal');
            } catch (error) {
                console.error('Erro ao editar designação:', error);
                showToast('Erro ao editar designação: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveDesignation() {
            try {
                if (!supabaseClient) {
                    throw new Error('Conexão com banco de dados não estabelecida');
                }

                // Coletar dados do formulário
                const id = document.getElementById('designation-id').value;
                const data = document.getElementById('designation-date').value;
                const funcao = document.getElementById('designation-function').value;
                const irmao_id = document.getElementById('designation-brother').value;
                const observacoes = document.getElementById('designation-observations').value;

                // Validar dados
                if (!data || !funcao || !irmao_id) {
                    showToast('Por favor, preencha todos os campos obrigatórios.', 'error');
                    return;
                }

                // Verificar se o irmão pode exercer a função selecionada
                const irmaoSelecionado = brothers.find(brother => brother.id === irmao_id);
                
                if (!irmaoSelecionado) {
                    showToast('Irmão selecionado não encontrado.', 'error');
                    return;
                }

                // Verificar se o irmão está disponível
                if (!irmaoSelecionado.disponivel) {
                    showToast(`O irmão ${irmaoSelecionado.nome} não está disponível para designações.`, 'error');
                    return;
                }

                // Verificar compatibilidade de funções
                const funcaoCompativel = verificarCompatibilidadeFuncao(funcao, irmaoSelecionado.funcoes);
                
                if (!funcaoCompativel) {
                    showToast(`O irmão ${irmaoSelecionado.nome} não está habilitado para a função "${funcao}". 
                               Funções disponíveis: ${irmaoSelecionado.funcoes?.join(', ') || 'Nenhuma função cadastrada'}.`, 'error');
                    return;
                }

                // Verificar se já existe designação para a mesma data e função (somente para novas designações)
                if (!id) {
                    const existeDesignacao = designations.find(d => 
                        d.data === data && d.funcao === funcao
                    );
                    
                    if (existeDesignacao) {
                        const irmaoExistente = brothers.find(b => b.id === existeDesignacao.irmao_id);
                        showToast(`Já existe uma designação para "${funcao}" em ${formatDate(data)} (${irmaoExistente?.nome || 'Irmão não encontrado'}).`, 'error');
                        return;
                    }
                }

                showLoading('Salvando designação...');

                const designation = {
                    data: data,
                    funcao: funcao,
                    irmao_id: irmao_id,
                    observacoes: observacoes || null
                };

                console.log('Dados a serem salvos:', designation);

                let result;

                if (id) {
                    // Editar - verificar se não há conflito com outras designações
                    const existeOutraDesignacao = designations.find(d => 
                        d.data === data && d.funcao === funcao && d.id !== id
                    );
                    
                    if (existeOutraDesignacao) {
                        const irmaoExistente = brothers.find(b => b.id === existeOutraDesignacao.irmao_id);
                        showToast(`Já existe uma designação para "${funcao}" em ${formatDate(data)} (${irmaoExistente?.nome || 'Irmão não encontrado'}).`, 'error');
                        return;
                    }

                    result = await supabaseClient
                        .from('designacoes_final')
                        .update(designation)
                        .eq('id', id)
                        .select();

                    if (result.error) {
                        console.error('Erro detalhado:', result.error);
                        throw result.error;
                    }

                    showToast('Designação atualizada com sucesso!');
                } else {
                    // Criar nova
                    result = await supabaseClient
                        .from('designacoes_final')
                        .insert([designation])
                        .select();

                    
            // Agendar notificação push
            schedulePush(irmao_id, data);
if (result.error) {
                        console.error('Erro detalhado:', result.error);
                        throw result.error;
                    }

                    showToast('Designação criada com sucesso!');
                }

                closeModal('designation-modal');
                await loadDesignations();
            } catch (error) {
                console.error('Erro ao salvar designação:', error);
                showToast('Erro ao salvar designação: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteDesignation(id) {
            try {
                const designation = designations.find(d => d.id === id);
                if (!designation) {
                    throw new Error('Designação não encontrada');
                }
                
                const brother = brothers.find(b => b.id === designation.irmao_id);
                const brotherName = brother ? brother.nome : 'Irmão não encontrado';
                
                // Usar o modal de confirmação em vez do confirm padrão
                const message = `Tem certeza que deseja excluir a designação de "${designation.funcao}" para o irmão "${brotherName}" em ${formatDate(designation.data)}?`;
                document.getElementById('confirmation-message').textContent = message;
                
                // Configurar ação de confirmação
                document.getElementById('btn-confirm-action').onclick = async () => {
                    try {
                        closeModal('confirmation-modal');
                        showLoading('Excluindo designação...');
                        
                        const { error } = await supabaseClient
                            .from('designacoes_final')
                            .delete()
                            .eq('id', id);
                        
                        if (error) throw error;
                        
                        showToast('Designação excluída com sucesso!');
                        await loadDesignations();
                    } catch (error) {
                        console.error('Erro ao excluir designação:', error);
                        showToast('Erro ao excluir designação: ' + error.message, 'error');
                    } finally {
                        hideLoading();
                    }
                };
                
                // Abrir modal de confirmação
                openModal('confirmation-modal');
                
            } catch (error) {
                console.error('Erro ao preparar exclusão:', error);
                showToast('Erro ao preparar exclusão: ' + error.message, 'error');
            }
        }

  // Exclusão em lote
        async function deleteSelectedDesignations() {
            const selectedCheckboxes = document.querySelectorAll('.designation-checkbox:checked:not(#select-all-designations)');
            const selectedIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);
            
            if (selectedIds.length === 0) {
                showToast('Nenhuma designação selecionada', 'warning');
                return;
            }
            
            // Mostrar confirmação
            document.getElementById('confirmation-message').textContent = 
                `Tem certeza que deseja excluir ${selectedIds.length} designação(ões)? Esta ação não pode ser desfeita.`;
            
            document.getElementById('btn-confirm-action').onclick = async () => {
                try {
                    closeModal('confirmation-modal');
                    showLoading('Excluindo designações...');
                    
                    // Excluir cada designação selecionada
                    for (const id of selectedIds) {
                        const { error } = await supabaseClient
                            .from('designacoes_final')
                            .delete()
                            .eq('id', id);
                        
                        if (error) throw error;
                    }
                    
                    showToast(`${selectedIds.length} designação(ões) excluída(s) com sucesso!`);
                    await loadDesignations();
                    
                    // Ocultar botão de exclusão em massa
                    document.getElementById('batch-delete-btn').style.display = 'none';
                    
                } catch (error) {
                    console.error('Erro ao excluir designações:', error);
                    showToast('Erro ao excluir designações: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            };
            
            openModal('confirmation-modal');
        }

        // Gestão de Irmãos
        function openNewBrotherModal() {
            // Limpar formulário
            document.getElementById('brother-form').reset();
            document.getElementById('brother-id').value = '';
            document.getElementById('brother-available').checked = true;

            // Alterar título do modal
            document.getElementById('brother-modal-title').textContent = 'Novo Irmão';

            openModal('brother-modal');
        }

        async function editBrother(id) {
            try {
                showLoading('Carregando irmão...');

                const brother = brothers.find(b => b.id === id);
                if (!brother) {
                    throw new Error('Irmão não encontrado');
                }

                // Preencher formulário
                document.getElementById('brother-id').value = brother.id;
                document.getElementById('brother-name').value = brother.nome;
                document.getElementById('brother-phone').value = brother.telefone || '';
                document.getElementById('brother-email').value = brother.email || '';
                document.getElementById('brother-available').checked = brother.disponivel;
                document.getElementById('brother-observations').value = brother.observacoes || '';

                // Marcar as funções
                document.querySelectorAll('.checkbox-group-improved input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.id !== 'brother-available') {
                        checkbox.checked = brother.funcoes && brother.funcoes.includes(checkbox.value);
                    }
                });

                // Alterar título do modal
                document.getElementById('brother-modal-title').textContent = 'Editar Irmão';

                // Fechar modal de gerenciamento se estiver aberto
                closeModal('manage-brothers-modal');

                openModal('brother-modal');
            } catch (error) {
                console.error('Erro ao editar irmão:', error);
                showToast('Erro ao editar irmão: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveBrother() {
            try {
                if (!supabaseClient) {
                    throw new Error('Conexão com banco de dados não estabelecida');
                }

                // Coletar dados do formulário
                const id = document.getElementById('brother-id').value;
                const nome = document.getElementById('brother-name').value;
                const telefone = document.getElementById('brother-phone').value;
                const email = document.getElementById('brother-email').value;
                const disponivel = document.getElementById('brother-available').checked;
                const observacoes = document.getElementById('brother-observations').value;

                // Coletar funções selecionadas
                const funcoes = [];
                document.querySelectorAll('.checkbox-group-improved input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.id !== 'brother-available') {
                        funcoes.push(checkbox.value);
                    }
                });

                // Validar dados
                if (!nome) {
                    showToast('Por favor, informe o nome do irmão.', 'error');
                    return;
                }

                showLoading('Salvando irmão...');

                const brother = {
                    nome,
                    telefone,
                    email,
                    funcoes,
                    disponivel,
                    observacoes
                };

                console.log('Dados do irmão a serem salvos:', brother);

                let result;

    if (id) {
                    // Editar
                    result = await supabaseClient
                        .from('irmaos')
                        .update(brother)
                        .eq('id', id);

                    if (result.error) throw result.error;

                    showToast('Irmão atualizado com sucesso!');
                } else {
                    // Criar novo
                    result = await supabaseClient
                        .from('irmaos')
                        .insert([brother]);

                    if (result.error) throw result.error;

                    showToast('Irmão cadastrado com sucesso!');
                }

                closeModal('brother-modal');
                await loadBrothers();
                
                // Atualizar tabela de gerenciamento se estiver aberta
                if (document.getElementById('manage-brothers-modal').classList.contains('active')) {
                    displayBrothersManagement();
                }
            } catch (error) {
                console.error('Erro ao salvar irmão:', error);
                showToast('Erro ao salvar irmão: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Gerenciamento de Irmãos
        function openManageBrothersModal() {
            console.log('Abrindo modal de gerenciamento de irmãos...');
            console.log('Brothers array:', brothers);
            console.log('Total de irmãos:', brothers.length);
            
            displayBrothersManagement();
            openModal('manage-brothers-modal');
            
            console.log('Modal de gerenciamento deve estar aberto agora');
        }

        function displayBrothersManagement() {
            const tbody = document.getElementById('brothers-body');
            const emptyState = document.getElementById('brothers-empty-state');

            // Atualizar estatísticas
            const totalBrothers = brothers.length;
            const availableBrothers = brothers.filter(b => b.disponivel).length;
            
            document.getElementById('brothers-count').textContent = `${totalBrothers} ${totalBrothers === 1 ? 'irmão cadastrado' : 'irmãos cadastrados'}`;
            document.getElementById('available-count').textContent = `${availableBrothers} ${availableBrothers === 1 ? 'disponível' : 'disponíveis'}`;

            // Limpar a tabela
            tbody.innerHTML = '';

            if (brothers.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            // Ordenar por nome
            const sortedBrothers = [...brothers].sort((a, b) => a.nome.localeCompare(b.nome));

            // Preencher a tabela - mostrar TODOS os irmãos
            sortedBrothers.forEach(brother => {
                const tr = document.createElement('tr');
                
                // Avatar com inicial do nome
                const inicial = brother.nome.charAt(0).toUpperCase();
                
                // Formatação das funções com tags
                let functionsHtml = '';
                if (brother.funcoes && brother.funcoes.length > 0) {
                    functionsHtml = brother.funcoes.map(funcao => {
                        const shortName = funcao.replace('Leitor ', '').replace(' Bíblico', '').replace(' de Áudio', '').replace(' do Operador', '');
                        const cssClass = getFunctionClass(funcao);
                        return `<span class="function-tag ${cssClass}">${shortName}</span>`;
                    }).join('');
                } else {
                    functionsHtml = '<span style="color: #999; font-style: italic;">Nenhuma função</span>';
                }

                // Informações de contato
                const phone = brother.telefone || '';
                const email = brother.email || '';
                let contactInfo = '';
                if (phone && email) {
                    contactInfo = `${phone}<br><span style="font-size: 14px; color: #888;">${email}</span>`;
                } else if (phone) {
                    contactInfo = phone;
                } else if (email) {
                    contactInfo = `<span style="font-size: 14px; color: #888;">${email}</span>`;
                } else {
                    contactInfo = '-';
                }

                const statusBadge = brother.disponivel 
                    ? '<span class="status-badge status-available">Disponível</span>'
                    : '<span class="status-badge status-unavailable">Indisponível</span>';

                tr.innerHTML = `
                    <td>
                        <div class="brother-info">
                            <div class="brother-avatar">${inicial}</div>
                            <div class="brother-details">
                                <h4>${brother.nome}</h4>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="brother-contact">${contactInfo}</div>
                    </td>
                    <td>
                        <div class="function-tags">${functionsHtml}</div>
                    </td>
                    <td>${statusBadge}</td>
                    <td class="table-actions">
                        <button class="action-btn edit-btn" data-id="${brother.id}" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${brother.id}" title="Excluir">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

                // Adicionar event listeners para os botões de ação
                tr.querySelector('.edit-btn').addEventListener('click', () => editBrother(brother.id));
                tr.querySelector('.delete-btn').addEventListener('click', () => confirmDeleteBrother(brother.id, brother.nome));

                tbody.appendChild(tr);
            });

            console.log(`Exibindo ${sortedBrothers.length} irmãos na tabela`);
        }

        function confirmDeleteBrother(id, nome) {
            const message = `Tem certeza que deseja excluir o irmão "${nome}"? Esta ação não pode ser desfeita.`;
            document.getElementById('confirmation-message').textContent = message;
            
            // Configurar ação de confirmação
            document.getElementById('btn-confirm-action').onclick = () => {
                deleteBrother(id);
                closeModal('confirmation-modal');
            };
            
            openModal('confirmation-modal');
        }

        async function deleteBrother(id) {
            try {
                showLoading('Excluindo irmão...');

                // Verificar se há designações para este irmão
                const designationsCount = designations.filter(d => d.irmao_id === id).length;
                
                if (designationsCount > 0) {
                    showToast(`Este irmão possui ${designationsCount} designação(ões). Remova as designações primeiro.`, 'error');
                    return;
                }

                const { error } = await supabaseClient
                    .from('irmaos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showToast('Irmão excluído com sucesso!');
                await loadBrothers();
                displayBrothersManagement();
                
            } catch (error) {
                console.error('Erro ao excluir irmão:', error);
                showToast('Erro ao excluir irmão: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Geração Automática
        function openAutoGenerateModal() {
            // Limpar e configurar o formulário
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(today.getMonth() + 1);

            document.getElementById('auto-start-date').value = today.toISOString().split('T')[0];
            document.getElementById('auto-end-date').value = nextMonth.toISOString().split('T')[0];

            openModal('auto-generate-modal');
        }

        async function generateAutomaticDesignations() {
            try {
                const startDate = corrigirData(document.getElementById('auto-start-date').value);
                const endDate = corrigirData(document.getElementById('auto-end-date').value);
                
                // Obter dias da semana selecionados (seleção exclusiva garantida)
                const selectedDays = getDiasSelecionados();
                const principalChecked = document.getElementById('day-group-principal').checked;
                const adicionalChecked = document.getElementById('day-group-adicional').checked;
                
                if (adicionalChecked) {
                    selectedDays.push(3, 6); // Quarta-feira e Sábado
                    console.log("🔍 DEBUG: Usando Quarta-feira + Sábado");
                } else if (principalChecked) {
                    selectedDays.push(4, 0); // Quinta-feira e Domingo
                    console.log("🔍 DEBUG: Usando Quinta-feira + Domingo");
                }
                
                console.log("🔍 DEBUG: Dias selecionados:", selectedDays);
                console.log("🔍 DEBUG: Principal checked:", principalChecked);
                console.log("🔍 DEBUG: Adicional checked:", adicionalChecked);
                
                // Verificar se nenhum dia foi selecionado
                if (selectedDays.length === 0) {
                    showToast('Selecione pelo menos um grupo de dias', 'error');
                    return;
                }
                
                // Limpar designações existentes no período antes de gerar novas
                console.log("🧹 Limpando designações existentes no período...");
                const existingDesignations = designations.filter(d => {
                    const designationDate = corrigirData(d.data);
                    return designationDate >= startDate && designationDate <= endDate;
                });
                
                for (const designation of existingDesignations) {
                    await deleteDesignation(designation.id, false); // false = não mostrar toast
                }
                
                console.log(`🧹 ${existingDesignations.length} designações existentes removidas`);
                
                // Obter funções selecionadas
                const selectedFunctions = [];
                if (document.getElementById('auto-func-indicador').checked) {
                    selectedFunctions.push('Indicador Auditório', 'Indicador de Entrada');
                }
                if (document.getElementById('auto-func-microfone').checked) {
                    selectedFunctions.push('Microfone 1', 'Microfone 2');
                }
                if (document.getElementById('auto-func-som').checked) {
                    selectedFunctions.push('Operador de Áudio', 'Ajudante do Operador');
                }
                if (document.getElementById('auto-func-leitores').checked) {
                    selectedFunctions.push('Leitor Estudo Bíblico', 'Leitor Sentinela');
                }

                if (selectedDays.length === 0) {
                    showToast('Selecione pelo menos um dia da semana', 'error');
                    return;
                }

                if (selectedFunctions.length === 0) {
                    showToast('Selecione pelo menos uma função', 'error');
                    return;
                }

                if (startDate > endDate) {
                    showToast('A data inicial deve ser anterior à data final', 'error');
                    return;
                }

                showLoading('Gerando designações automáticas...');

                // Usar a função avançada de geração
                const novasDesignacoes = await gerarDesignacoesAutomaticamente(startDate, endDate, selectedDays, selectedFunctions);
                
                if (novasDesignacoes.length === 0) {
                    showToast('Nenhuma nova designação foi gerada. Verifique as datas e disponibilidade dos irmãos.', 'warning');
                    hideLoading();
                    return;
                }
                
                // Enviar designações geradas para o banco de dados
                const { error } = await supabaseClient
                    .from('designacoes_final')
                    .insert(novasDesignacoes);
                
                if (error) throw error;
                
                showToast(`${novasDesignacoes.length} designações geradas com sucesso!`);
                await loadDesignations();
                closeModal('auto-generate-modal');
            } catch (error) {
                console.error('Erro ao gerar designações automáticas:', error);
                showToast('Erro ao gerar designações: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

   // NOVA FUNCIONALIDADE: Lista para Impressão ATUALIZADA
        function openPrintModal() {
            // Preencher anos disponíveis
            const currentYear = new Date().getFullYear();
            const yearSelects = ['print-year', 'print-year2'];
            
            yearSelects.forEach(selectId => {
                const yearSelect = document.getElementById(selectId);
                yearSelect.innerHTML = '';
                
                for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
            });

            // Definir mês atual
            const currentMonth = new Date().getMonth();
            document.getElementById('print-month').value = currentMonth;

            // Limpar seleções anteriores
            document.querySelectorAll('.print-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Definir período padrão (1 mês)
            document.querySelectorAll('.period-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.period-option[data-period="1"]').classList.add('selected');

            // Mostrar seleção de 1 mês por padrão
            document.getElementById('single-month-selection').classList.add('show');
            document.getElementById('double-month-selection').classList.remove('show');

            openModal('print-modal');
        }

        function setupPrintOptions() {
            // Configurar seleção de tipo de lista
            document.querySelectorAll('.print-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remover seleção anterior
                    document.querySelectorAll('.print-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Adicionar seleção atual
                    this.classList.add('selected');
                });
            });

            // NOVO: Configurar seleção de período
            document.querySelectorAll('.period-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remover seleção anterior
                    document.querySelectorAll('.period-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Adicionar seleção atual
                    this.classList.add('selected');

                    // Mostrar/ocultar seções apropriadas
                    const period = this.dataset.period;
                    if (period === '1') {
                        document.getElementById('single-month-selection').classList.add('show');
                        document.getElementById('double-month-selection').classList.remove('show');
                    } else {
                        document.getElementById('single-month-selection').classList.remove('show');
                        document.getElementById('double-month-selection').classList.add('show');
                    }
                });
            });
        }

        async function generatePrintList() {
            try {
                const selectedOption = document.querySelector('.print-option.selected');
                const selectedPeriod = document.querySelector('.period-option.selected');

                if (!selectedOption) {
                    showToast('Selecione um tipo de lista', 'error');
                    return;
                }

                if (!selectedPeriod) {
                    showToast('Selecione o período', 'error');
                    return;
                }

                const listType = selectedOption.dataset.type;
                const period = selectedPeriod.dataset.period;

                let months = [];
                let year;

                if (period === '1') {
                    // 1 mês
                    const month = document.getElementById('print-month').value;
                    year = document.getElementById('print-year').value;

                    if (!month || !year) {
                        showToast('Selecione o mês e ano', 'error');
                        return;
                    }

                    months = [parseInt(month)];
                } else {
                    // 2 meses
                    const month1 = document.getElementById('print-month1').value;
                    const month2 = document.getElementById('print-month2').value;
                    year = document.getElementById('print-year2').value;

                    if (!month1 || !month2 || !year) {
                        showToast('Selecione os dois meses e o ano', 'error');
                        return;
                    }

                    months = [parseInt(month1), parseInt(month2)];
                }

                showLoading('Gerando lista para impressão...');

                // Filtrar designações por meses e ano
                const filteredDesignations = designations.filter(d => {
                    const date = new Date(d.data + "T00:00:00");
                    return months.includes(date.getMonth()) && date.getFullYear() === parseInt(year);
                });

                // Filtrar por tipo de função
                let functionsToInclude = [];
                let typeTitle = '';
                
                switch(listType) {
                    case 'leitores':
                        functionsToInclude = ['Leitor Estudo Bíblico', 'Leitor Sentinela'];
                        typeTitle = 'Leitores';
                        break;
                    case 'microfones':
                        functionsToInclude = ['Microfone 1', 'Microfone 2'];
                        typeTitle = 'Microfones';
                        break;
                    case 'indicadores':
                        functionsToInclude = ['Indicador Auditório', 'Indicador de Entrada'];
                        typeTitle = 'Indicadores';
                        break;
                    case 'som':
                        functionsToInclude = ['Operador de Áudio', 'Ajudante do Operador'];
                        typeTitle = 'Sistema de Áudio e Vídeo';
                        break;
                }

                const listDesignations = filteredDesignations.filter(d => 
                    functionsToInclude.includes(d.funcao)
                );

                if (listDesignations.length === 0) {
                    showToast('Nenhuma designação encontrada para o período e tipo selecionados', 'warning');
                    hideLoading();
                    return;
                }

                // Gerar HTML para impressão seguindo o modelo fornecido
                generateAdvancedPrintHTML(listDesignations, listType, typeTitle, months, year, functionsToInclude);
                
                closeModal('print-modal');
                
            } catch (error) {
                console.error('Erro ao gerar lista:', error);
                showToast('Erro ao gerar lista: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // FUNÇÃO MODIFICADA: Gerar HTML sem o QR Code
        function generateAdvancedPrintHTML(designationsData, listType, typeTitle, months, year, functionsToInclude) {
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            // Criar título do período
            let periodTitle = '';
            if (months.length === 1) {
                periodTitle = `${monthNames[months[0]]} de ${year}`;
            } else {
                periodTitle = `${monthNames[months[0]]} e ${monthNames[months[1]]} de ${year}`;
            }

            // Organizar designações por mês e função
            const organizedData = {};
            months.forEach(month => {
                organizedData[month] = {};
                functionsToInclude.forEach(func => {
                    organizedData[month][func] = designationsData
                        .filter(d => {
                            const date = new Date(d.data + "T00:00:00");
                            return date.getMonth() === month && d.funcao === func;
                        })
                        .sort((a, b) => new Date(a.data + "T00:00:00") - new Date(b.data + "T00:00:00"));
                });
            });

            // Definir classe de estilo conforme tipo de lista
let typeClass = "";
if (typeTitle === 'Microfones') typeClass = 'microfones';
else if (typeTitle === 'Indicadores') typeClass = 'indicadores';
else if (typeTitle === 'Sistema de Áudio e Vídeo') typeClass = 'audio-video';
else if (typeTitle === 'Leitores') typeClass = 'leitores';

let htmlContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Lista de ${typeTitle} - Congregação Veredas</title>
                    <style>
                        @page { size: A4 portrait; margin: 0.5cm; }
                            @media print { body { zoom: 90%; } }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0; padding: 0; background: white; color: #2d3748;
                            line-height: 1.3; -webkit-font-smoothing: antialiased;
                        }
                        .document-wrapper { background: white; width: 100%; }
                        .header-container {
                            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
                            padding: 12px 20px; border-bottom: 1px solid #e2e8f0; text-align: center;
                         position: relative;}
                        .qr-code {
                            position: absolute;
                            top: 50%;
                            right: 20px;
                            transform: translateY(-50%);
                            width: 90px;
                            height: 90px;
                        }
                        .qr-code img {
                            width: 100%;
                            height: 100%;
                        }

                        .header-content h1 {
                            font-size: 28px; font-weight: 700; margin: 0 0 4px 0;
                            color: #2d3748; letter-spacing: -0.5px;
                        }
                        .header-content h2 { font-size: 18px;
                            font-size: 15px; font-weight: 500; margin: 0 0 3px 0; color: #4a90e2;
                        }
    /* Estilos por tipo de lista */
    .header-content.indicadores h1 { color: #48BB78; }
    .header-content.microfones h1 { color: #FFA500; }
    .header-content.audio-video h1 { color: #805AD5; }
    .header-content.leitores h1 { color: #4a90e2; }

                        .header-subtitle {
                            font-size: 14px; color: #718096; font-weight: 400;
                            letter-spacing: 0.5px; text-transform: uppercase;
                        }
                        .content-section { padding: 15px 20px 10px 20px; }
                        .legend-section {
                            display: flex; justify-content: center; gap: 40px; margin-bottom: 15px;
                            padding: 8px; background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
                            border-radius: 4px; border: 1px solid #e2e8f0;
                        }
                        .legend-item {
                            display: flex; align-items: center; gap: 8px;
                            font-size: 14px; font-weight: 500; color: #4a5568;
                        }
                        .month-section {
                            margin-bottom: 16px; background: white; border-radius: 6px;
                            border: 1px solid #e2e8f0; overflow: hidden;
                            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
                        }
                        .month-section:last-child { margin-bottom: 0; }
                        .month-header {
                            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                            color: white; padding: 8px 15px; text-align: center;
                            font-weight: 600; font-size: 14px; text-transform: uppercase;
                            letter-spacing: 0.8px;
                        }
                        .designations-table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        .designations-table th {
                            background: #f8fafc; color: #4a5568; padding: 8px 12px;
                            text-align: center; font-weight: 600; text-transform: uppercase;
                            letter-spacing: 0.5px; font-size: 14px; border-bottom: 1px solid #e2e8f0;
                        }
                        .designations-table td {
                            padding: 10px 12px; text-align: center; border-bottom: 1px solid #f1f5f9;
                            vertical-align: middle; transition: background-color 0.2s ease;
                        }
                        .designations-table tr:last-child td { border-bottom: none; }
                        .designations-table tr:nth-child(even) {
                            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                        }
                        .designations-table tr:nth-child(odd) { background: white; }
                        .date-column { width: 15%; font-weight: 700; color: #2d3748; font-size: 14px; }
                        .day-column { width: 15%; color: #718096; font-size: 14px; font-weight: 500; }
                        .function-column { width: 35%; font-weight: 500; font-size: 14px; }
                        .name-with-indicator {
                            display: inline-flex; align-items: center; gap: 6px; justify-content: center;
                        }
                        .role-indicator { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
                        .primary-indicator {
                            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                            box-shadow: 0 0 0 1px rgba(74, 144, 226, 0.2);
                        }
                        .secondary-indicator {
                            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
                            box-shadow: 0 0 0 1px rgba(72, 187, 120, 0.2);
                        }
                        .footer-container {
                            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
                            padding: 10px 20px; border-top: 1px solid #e2e8f0;
                            display: flex; justify-content: center; align-items: center; font-size: 14px;
                        }
                        .footer-content {
                            color: #4a90e2; font-weight: 600; font-size: 13px;
                        }
                        @media print {
                            body { background: white; }
                            .month-section { page-break-inside: avoid; }
                            .header-container, .footer-container, .legend-section { background: #f8fafc !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
                            .month-header { background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%) !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
                        }
                    
/* Correção de espaço entre o texto e a seta nos selects */
.select-container select {
    padding-right: 35px;
}

.select-container:after {
    right: 12px;
}


/* ===== MOBILE ENHANCEMENTS v1 (2025‑06‑25) ===== */
@media screen and (max-width:768px) {
  .controls{
      flex-direction:column;
      gap:10px;
  }
  .filters,.actions{
      width:100%;
      flex-wrap:wrap;
  }
  .filters .select-container,
  .actions .btn{
      flex:1 1 160px;
  }

  /* Make table cards instead of wide rows */
  table thead{
      display:none;
  }
  table, table tbody, table tr, table td{
      display:block;
      width:100%;
  }
  table tr{
      background:#ffffff;
      border:1px solid #e0e0e0;
      border-radius:8px;
      margin-bottom:12px;
      padding:12px 16px;
      box-shadow:0 1px 3px rgba(0,0,0,.05);
  }
  table td{
      border:none;
      padding:6px 0;
  }
  table td::before{
      content: attr(data-label);
      font-weight:600;
      color:#666;
      display:block;
      margin-bottom:4px;
      text-transform:capitalize;
  }

  /* Modal sizing */
  .modal{
      width:95%;
      height:90vh;
      max-width:95%;
  }
  .modal-body{
      padding:20px 16px;
  }
}


@media print{
  table{ display:table; table-layout:fixed; width:100%; }
  thead{ display:table-header-group; }
  tbody{ display:table-row-group; }
  tr{ page-break-inside:avoid; }
  td{ display:table-cell; }
}
</style>
                </head>
                <body>
                    <div class="document-wrapper">
                        <div class="header-container">
                            <div class="qr-code"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEoAAABKAQAAAAA0q//cAAABU0lEQVR4nJWTsWrDMBRFryotARUbOmXPBxicpWBjQ6aCoV8S6NoxkA/oB+Q/MhlU3CXgYkPWLIVAp4KMBF5sXpdS/Awdqklcnq7O1XsShJ/1eoPf9ce2E3m7Fq1QUxWOkqxKKHOGHVO9L/Zhl09rFYAD0s8UcxVrW8wvHvA0XN4CM1WFDWMAeJfllIHIkjMNEWPwohAPwVpwhrHun72vU89TDJnWlMQBcxj9bnVVx3HGe94M6/LWyJGp2oRm65ZHVqtT+XH3NUa6m6YY1NBftoDcMQapY02o2EuCrB1INzpmqnUaVUSS8SqdV50+qHLDslGNhBJrKubgHDWwOmO+CnlrqLVndKw2rpMYmZXcIUgqW0HOeMlmVlaO+3Zhtr/YMNKsx5K6cZWbErwXMmqkjcC7CSA/Pb44Px9P3/vNspjNTrDQp/sr5rPTLpyqWTbxjx/wDfpHndJHzD/JAAAAAElFTkSuQmCC" alt="QR Code"></div>
                            <div class="header-content ${typeClass}">
                                <h1>Lista de ${typeTitle}</h1>
                                <h2>Congregação Veredas – ${periodTitle}</h2>
                                <div class="header-subtitle">Escala de Designações${months.length === 2 ? ' Bimestral' : ''}</div>
                            </div>
                        </div>
                        <div class="content-section">
            `;

            // Adicionar legenda baseada no tipo
            if (listType === 'som') {
                      htmlContent += `
                    <div class="legend-section">
                        <div class="legend-item">
                            <span class="role-indicator primary-indicator"></span>
                            Operador Principal de Som
                        </div>
                        <div class="legend-item">
                            <span class="role-indicator secondary-indicator"></span>
                            Ajudante do Operador
                        </div>
                    </div>
                `;
            } else if (listType === 'leitores') {
                htmlContent += `
                    <div class="legend-section">
                        <div class="legend-item">
                            <span class="role-indicator primary-indicator"></span>
                            Leitor Estudo Bíblico
                        </div>
                        <div class="legend-item">
                            <span class="role-indicator secondary-indicator"></span>
                            Leitor Sentinela
                        </div>
                    </div>
                `;
    } else if (listType === 'microfones') {
                htmlContent += `
                    <div class="legend-section">
                        <div class="legend-item">
                            <span class="role-indicator primary-indicator"></span>
                            Microfone 1
                        </div>
                        <div class="legend-item">
                            <span class="role-indicator secondary-indicator"></span>
                            Microfone 2
                        </div>
                    </div>
                `;
            } else if (listType === 'indicadores') {
                htmlContent += `
                    <div class="legend-section">
                        <div class="legend-item">
                            <span class="role-indicator primary-indicator"></span>
                            Indicador Auditório
                        </div>
                        <div class="legend-item">
                            <span class="role-indicator secondary-indicator"></span>
                            Indicador de Entrada
                        </div>
                    </div>
                `;
            }

            // Adicionar seções dos meses
            months.forEach(month => {
                htmlContent += `
                    <div class="month-section">
                        <div class="month-header">${monthNames[month]} ${year}</div>
                        <table class="designations-table">
                            <thead>
                                <tr>
                                    <th class="date-column">Data da Reunião</th>
                                    <th class="day-column">Dia da Semana</th>
                `;

                // Adicionar cabeçalhos das colunas baseado no tipo
                if (listType === 'som') {
                    htmlContent += `
                                    <th class="function-column">Operador de Som</th>
                                    <th class="function-column">Ajudante do Operador</th>
                    `;
                } else if (listType === 'leitores') {
                    htmlContent += `
                                    <th class="function-column">Leitor Estudo Bíblico</th>
                                    <th class="function-column">Leitor Sentinela</th>
                    `;
                } else if (listType === 'microfones') {
                    htmlContent += `
                                    <th class="function-column">Microfone 1</th>
                                    <th class="function-column">Microfone 2</th>
                    `;
                } else if (listType === 'indicadores') {
                    htmlContent += `
                                    <th class="function-column">Indicador Auditório</th>
                                    <th class="function-column">Indicador de Entrada</th>
                    `;
                }

                htmlContent += `
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Obter todas as datas únicas do mês
                const datesInMonth = [...new Set(
                    designationsData
                        .filter(d => new Date(d.data + "T00:00:00").getMonth() === month)
                        .map(d => d.data)
                )].sort();

                // Para cada data, criar uma linha
                datesInMonth.forEach(date => {
                    const dateObj = new Date(date + "T00:00:00");
                    const dayName = getDayOfWeekName(dateObj.getDay());
                    
                    htmlContent += `
                        <tr>
                            <td class="date-column">${formatDate(date)}</td>
                            <td class="day-column">${dayName}</td>
                    `;

                    // Adicionar colunas das funções
                    functionsToInclude.forEach((func, index) => {
                        const designation = organizedData[month][func]?.find(d => d.data === date);
                        const brother = designation ? brothers.find(b => b.id === designation.irmao_id) : null;
                        const brotherName = brother ? brother.nome : '-';
                        
                        const indicatorClass = index === 0 ? 'primary-indicator' : 'secondary-indicator';
                        
                        htmlContent += `
                            <td class="function-column">
                                <div class="name-with-indicator">
                                    <span class="role-indicator ${indicatorClass}"></span>
                                    ${brotherName}
                                </div>
                            </td>
                        `;
                    });

                    htmlContent += `</tr>`;
                });

                htmlContent += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Footer simplificado (sem QR Code)
            htmlContent += `
                        </div>
                        <div class="footer-container">
                            <div class="footer-content">Congregação Veredas</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Abrir em nova janela para impressão
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Aguardar o carregamento e abrir a janela de impressão
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };

            showToast(`Lista de ${typeTitle} gerada com sucesso!`);
        }

        // Função auxiliar para obter nome do dia da semana
        function getDayOfWeekName(dayIndex) {
            const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            return days[dayIndex];
        }

        // Funções de Backup e Importação
        async function exportBackup() {
            try {
                showLoading('Preparando backup...');
                
                // Buscar todos os dados necessários
                const { data: designationsData, error: designationsError } = await supabaseClient
                    .from('designacoes_final')
                    .select('*');
                    
                const { data: brothersData, error: brothersError } = await supabaseClient
                    .from('irmaos')
                    .select('*');
                
                if (designationsError) throw designationsError;
                if (brothersError) throw brothersError;
                
                // Formatar os dados para o backup
                const backupData = {
                    version: '1.0',
                    date: new Date().toISOString(),
                    brothers: brothersData,
                    designations: designationsData
                };
                
                // Criar arquivo de download
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(dataBlob);
                downloadLink.download = `designacoes_backup_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                showToast('Backup exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                showToast('Erro ao exportar backup: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function importBackup() {
            document.getElementById('import-file').click();
        }

        async function processImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showLoading('Processando arquivo de backup...');
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validar dados de backup
                        if (!backupData.brothers || !backupData.designations) {
                            throw new Error('Arquivo de backup inválido ou corrompido.');
                        }
                        
                        // Confirmar com o usuário
                        document.getElementById('confirmation-message').innerHTML = `
                            <p>Tem certeza que deseja importar este backup?</p>
                            <p><strong>Atenção:</strong> Esta ação irá substituir todos os dados existentes!</p>
                            <ul>
                                <li><strong>Irmãos:</strong> ${backupData.brothers.length}</li>
                                <li><strong>Designações:</strong> ${backupData.designations.length}</li>
                                <li><strong>Data do backup:</strong> ${new Date(backupData.date).toLocaleDateString('pt-BR')}</li>
                            </ul>
                        `;
                        
                        document.getElementById('btn-confirm-action').onclick = () => {
                            closeModal('confirmation-modal');
                            confirmImport(backupData);
                        };
                        
                        openModal('confirmation-modal');
                        hideLoading();
                        
                    } catch (error) {
                        console.error('Erro ao processar arquivo:', error);
                        showToast('Erro ao processar arquivo: ' + error.message, 'error');
                        hideLoading();
                    }
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Erro ao processar arquivo:', error);
                showToast('Erro ao processar arquivo: ' + error.message, 'error');
                hideLoading();
            }
            
            // Limpar o input file para permitir selecionar o mesmo arquivo novamente
            event.target.value = '';
        }

        async function confirmImport(backupData) {
            try {
                showLoading('Importando dados...');
                
                // 1. Limpar dados existentes
                const { error: clearBrothersError } = await supabaseClient
                    .from('irmaos')
                    .delete()
                    .not('id', 'is', null);
                    
                const { error: clearDesignationsError } = await supabaseClient
                    .from('designacoes_final')
                    .delete()
                    .not('id', 'is', null);
                    
                if (clearBrothersError) throw clearBrothersError;
                if (clearDesignationsError) throw clearDesignationsError;
                
                // 2. Inserir dados de backup
                
                // 2.1 Inserir irmãos
                const brothersToInsert = backupData.brothers.map(({ id, ...rest }) => rest);
                
                const { error: insertBrothersError } = await supabaseClient
                    .from('irmaos')
                    .insert(brothersToInsert);
                    
                if (insertBrothersError) throw insertBrothersError;
                
                // 2.2 Obter novos IDs dos irmãos para mapear nas designações
                const { data: newBrothers, error: getBrothersError } = await supabaseClient
                    .from('irmaos')
                    .select('*');
                    
                if (getBrothersError) throw getBrothersError;
                
                // Criar um mapa de nomes para novos IDs
                const brotherNameToIdMap = {};
                newBrothers.forEach(brother => {
                    brotherNameToIdMap[brother.nome] = brother.id;
                });
                
                // Criar mapa de IDs antigos para nomes
                const oldIdToNameMap = {};
                backupData.brothers.forEach(brother => {
                    oldIdToNameMap[brother.id] = brother.nome;
                });
                
                // 2.3 Inserir designações com os novos IDs de irmãos
                const designationsToInsert = backupData.designations.map(({ id, irmao_id, ...rest }) => {
                    const irmaoNome = oldIdToNameMap[irmao_id];
                    const novoIrmaoId = brotherNameToIdMap[irmaoNome];
                    
                    return {
                        ...rest,
                        irmao_id: novoIrmaoId
                    };
                });
                
                const { error: insertDesignationsError } = await supabaseClient
                    .from('designacoes_final')
                    .insert(designationsToInsert);
                    
                if (insertDesignationsError) throw insertDesignationsError;
                
                showToast('Dados importados com sucesso!', 'success');
                
                // Recarregar os dados
                await loadBrothers();
                await loadDesignations();
                
            } catch (error) {
                console.error('Erro ao importar backup:', error);
                showToast('Erro ao importar backup: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

  // Event Listeners para inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Aguardar a biblioteca Supabase estar disponível
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Biblioteca Supabase não carregada');
                }
                
                // Criar cliente Supabase
                
                console.log('Supabase conectado com sucesso!');
                
                // Carregar dados iniciais
                await loadBrothers();
                await loadDesignations();
                
                // Configurar event listeners
                setupEventListeners();
                
                // Configurar opções de impressão
                setupPrintOptions();
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao conectar com o banco de dados: ' + error.message, 'error');
            }
        });

        // Funções para Botões Toggle do Modal de Geração Automática
        function toggleAllDays() {
            const principalCheckbox = document.getElementById('day-group-principal');
            const adicionalCheckbox = document.getElementById('day-group-adicional');
            const toggleBtn = document.getElementById('toggle-all-days');
            
            // Verificar estado atual
            const allChecked = principalCheckbox.checked && adicionalCheckbox.checked;
            
            if (allChecked) {
                // Desmarcar todos
                principalCheckbox.checked = false;
                adicionalCheckbox.checked = false;
                toggleBtn.innerHTML = '<i class="fas fa-check-square"></i> Marcar Todos';
            } else {
                // Marcar todos
                principalCheckbox.checked = true;
                adicionalCheckbox.checked = true;
                toggleBtn.innerHTML = '<i class="fas fa-minus-square"></i> Desmarcar Todos';
            }
        }

        function toggleAllFunctions() {
            const functionCheckboxes = document.querySelectorAll('#auto-generate-modal input[type="checkbox"][id^="auto-func-"]');
            const toggleBtn = document.getElementById('toggle-all-functions');
            const allChecked = Array.from(functionCheckboxes).every(cb => cb.checked);
            
            functionCheckboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            // Atualizar texto do botão
            const icon = toggleBtn.querySelector('i');
            if (allChecked) {
                icon.className = 'fas fa-square';
                toggleBtn.innerHTML = '<i class="fas fa-square"></i> Marcar Todas';
            } else {
                icon.className = 'fas fa-check-square';
                toggleBtn.innerHTML = '<i class="fas fa-check-square"></i> Desmarcar Todas';
            }
        }

        function toggleAllSettings() {
            const settingCheckboxes = document.querySelectorAll('#auto-generate-modal input[type="checkbox"][id^="auto-"]:not([id^="auto-func-"])');
            const toggleBtn = document.getElementById('toggle-all-settings');
            const allChecked = Array.from(settingCheckboxes).every(cb => cb.checked);
            
            settingCheckboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            // Atualizar texto do botão
            const icon = toggleBtn.querySelector('i');
            if (allChecked) {
                icon.className = 'fas fa-square';
                toggleBtn.innerHTML = '<i class="fas fa-square"></i> Marcar Todas';
            } else {
                icon.className = 'fas fa-check-square';
                toggleBtn.innerHTML = '<i class="fas fa-check-square"></i> Desmarcar Todas';
            }
        }

        // Função para melhorar campos de data
        function setupDateInputs() {
            // Adicionar funcionalidade de clique em qualquer lugar do wrapper
            document.querySelectorAll('.date-input-wrapper').forEach(wrapper => {
                wrapper.addEventListener('click', function(e) {
                    if (e.target !== this.querySelector('input')) {
                        const input = this.querySelector('input[type="date"]');
                        if (input && input.showPicker) {
                            try {
                                input.showPicker();
                            } catch (error) {
                                // Fallback para navegadores que não suportam showPicker
                                input.focus();
                            }
                        } else {
                            input.focus();
                        }
                    }
                });
            });
        }

        // Event Listeners para botões principais
        function setupEventListeners() {

// Event listeners para seleção exclusiva dos dias da semana
const principalCheckbox = document.getElementById('day-group-principal');
const adicionalCheckbox = document.getElementById('day-group-adicional');

if (principalCheckbox && adicionalCheckbox) {
    principalCheckbox.addEventListener('change', function() {
        if (this.checked) {
            adicionalCheckbox.checked = false;
            console.log("🔄 Principal selecionado, desmarcando adicional");
        }
    });
    
    adicionalCheckbox.addEventListener('change', function() {
        if (this.checked) {
            principalCheckbox.checked = false;
            console.log("🔄 Adicional selecionado, desmarcando principal");
        }
    });
}

// Abrir calendário automaticamente ao clicar no campo de data do modal de Designação
const designationDateInput = document.getElementById('designation-date');
if (designationDateInput && designationDateInput.showPicker) {
    designationDateInput.addEventListener('click', () => {
        designationDateInput.showPicker();
    });
}

// Novo checkbox para marcar/desmarcar todas as funções a gerar
const selectAllFuncCheckbox = document.getElementById('auto-func-select-all');
if (selectAllFuncCheckbox) {
    const functionCheckboxes = document.querySelectorAll('#auto-generate-modal input[type="checkbox"][id^="auto-func-"]');

    // Marcar/desmarcar todos quando o checkbox principal mudar
    selectAllFuncCheckbox.addEventListener('change', () => {
        functionCheckboxes.forEach(cb => cb.checked = selectAllFuncCheckbox.checked);
    });

    // Atualizar o checkbox principal quando qualquer função mudar
    functionCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            const allChecked = Array.from(functionCheckboxes).every(cbInner => cbInner.checked);
            selectAllFuncCheckbox.checked = allChecked;
        });
    });
}
            // Eventos para modais
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeAllModals();
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', event => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // Eventos para botões principais
            document.getElementById('btn-new-designation').addEventListener('click', openNewDesignationModal);
            document.getElementById('btn-auto-generate').addEventListener('click', openAutoGenerateModal);
            document.getElementById('btn-new-brother').addEventListener('click', openNewBrotherModal);
            
            // Gerenciar irmãos com verificação adicional
            const manageBrothersBtn = document.getElementById('btn-manage-brothers');
            if (manageBrothersBtn) {
                manageBrothersBtn.addEventListener('click', function() {
                    console.log('Botão Gerenciar Irmãos clicado');
                    openManageBrothersModal();
                });
                console.log('Event listener para Gerenciar Irmãos configurado');
            } else {
                console.error('Botão btn-manage-brothers não encontrado!');
            }
            
            document.getElementById('btn-save-designation').addEventListener('click', saveDesignation);
            document.getElementById('btn-generate-auto').addEventListener('click', generateAutomaticDesignations);
            document.getElementById('btn-save-brother').addEventListener('click', saveBrother);

            // Botão adicionar irmão do modal de gerenciamento
            document.getElementById('btn-add-brother-from-manage').addEventListener('click', () => {
                closeModal('manage-brothers-modal');
                openNewBrotherModal();
            });

            // Eventos para filtros
            document.getElementById('filter-month').addEventListener('change', filterDesignations);
            document.getElementById('filter-function').addEventListener('change', filterDesignations);
            document.getElementById('filter-brother').addEventListener('change', filterDesignations);

            // Event listener para atualizar irmãos baseado na função
            document.getElementById('designation-function').addEventListener('change', updateBrotherOptions);

            // Botão Marcar/Desmarcar Todos
            document.getElementById('toggle-all-functions').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.checkbox-group-improved input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked && cb.id !== 'brother-available');
                
                checkboxes.forEach(cb => {
                    if (cb.id !== 'brother-available') {
                        cb.checked = !allChecked;
                    }
                });
                
                this.innerHTML = allChecked ? 
                    '<i class="fas fa-check-square"></i> Marcar Todos' : 
                    '<i class="fas fa-minus-square"></i> Desmarcar Todos';
            });

            // Event listeners para exclusão em lote
            document.getElementById('batch-delete-btn').addEventListener('click', deleteSelectedDesignations);

            // Event listeners para backup e importação
            document.getElementById('btn-backup').addEventListener('click', exportBackup);
            document.getElementById('btn-import').addEventListener('click', importBackup);
            document.getElementById('import-file').addEventListener('change', processImportFile);

            // Event listeners para Lista para Impressão ATUALIZADA
            document.getElementById('btn-print-list').addEventListener('click', openPrintModal);
            document.getElementById('btn-generate-print').addEventListener('click', generatePrintList);

            // Event listeners para exportação PDF
            document.getElementById('btn-export-pdf').addEventListener('click', () => {
                showToast('Funcionalidade de exportação PDF em desenvolvimento', 'info');
            });

            // Event listeners para botões toggle do modal de geração automática
            document.getElementById('toggle-all-days').addEventListener('click', toggleAllDays);
            document.getElementById('toggle-all-functions').addEventListener('click', toggleAllFunctions);
            document.getElementById('toggle-all-settings').addEventListener('click', toggleAllSettings);

            // Configurar campos de data melhorados
            setupDateInputs();

            console.log('Event listeners configurados com sucesso!');
        }

const { createClient } = supabase;
const supabaseClient = createClient(supabaseUrl, supabaseKey);

// CONSTANTE da chave REST API do OneSignal
const ONE_SIGNAL_REST_API_KEY = 'uwrn4t2lvejfvjnjvpxky5agn';

// Função para agendar notificação push às 13h do dia da designação
async function schedulePush(irmaoId, meetingDate) {
  const { data: irmao } = await supabaseClient
    .from('irmaos')
    .select('player_id')
    .eq('id', irmaoId)
    .single();
  if (!irmao || !irmao.player_id) return;
  const sendAfter = `${meetingDate}T13:00:00-03:00`;
  const body = {
    app_id: "866e424c-6172-40e0-9cba-fcfe75402d9a",
    include_player_ids: [irmao.player_id],
    headings: { en: "Lembrete de Designação" },
    contents: { en: `Você tem designação hoje às ${meetingDate}.` },
    send_after: sendAfter
  };
  await fetch("https://onesignal.com/api/v1/notifications", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Basic ${ONE_SIGNAL_REST_API_KEY}`
    },
    body: JSON.stringify(body)
  });
}

        // Configurar PDFMake quando disponível
        setTimeout(() => {
            if (typeof pdfMake !== 'undefined') {
                pdfMake.fonts = {
                    Roboto: {
                        normal: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf',
                        bold: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Medium.ttf',
                        italics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Italic.ttf',
                        bolditalics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-MediumItalic.ttf'
                    }
                };
                console.log('PDFMake configurado com sucesso!');
            }
        }, 1000);

        console.log('Sistema de Designações carregado!');
        
        // NOVA FUNÇÃO: Limpar e formatar número de telefone para WhatsApp
        function formatPhoneNumberForWhatsApp(phone) {
            if (!phone) return null;
            // Remove caracteres não numéricos e adiciona o código do Brasil (55)
            const cleanedPhone = phone.replace(/\D/g, '');
            if (cleanedPhone.length < 10 || cleanedPhone.length > 11) {
                console.warn('Número de telefone inválido:', phone);
                return null; // Retorna null se o número parecer inválido após limpeza
            }
            return '55' + cleanedPhone;
        }

        // NOVA FUNÇÃO: Enviar designação via WhatsApp
        async function sendDesignation(id) {
            try {
                console.log(`Tentando enviar designação com ID: ${id}`);
                const designation = designations.find(d => d.id === id);
                if (!designation) {
                    throw new Error('Designação não encontrada');
                }
                console.log('Designação encontrada:', designation);

                const brother = brothers.find(b => b.id === designation.irmao_id);
                if (!brother) {
                    throw new Error('Irmão não encontrado para esta designação');
                }
                console.log('Irmão encontrado:', brother);

                const brotherName = brother.nome;
                const brotherPhone = brother.telefone; // Certifique-se que 'telefone' é carregado em loadBrothers

                if (!brotherPhone) {
                    showToast(`O irmão ${brotherName} não possui número de telefone cadastrado.`, 'warning');
                    return;
                }

                const formattedPhoneNumber = formatPhoneNumberForWhatsApp(brotherPhone);
                if (!formattedPhoneNumber) {
                    showToast(`Número de telefone inválido para ${brotherName}: ${brotherPhone}`, 'error');
                    return;
                }

                const designationDate = new Date(designation.data + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário ao pegar só a data
                const dayOfWeekInfo = getDayOfWeekInfo(designation.data);
                const formattedDate = formatDate(designation.data); // Usa a função existente para DD/MM/YYYY
                const designationFunction = designation.funcao;
                const meetingTime = '18h30'; // Horário fixo conforme modelo - idealmente viria dos dados
                const congregationName = 'Congregação Veredas';
                const hallAddress = 'Av. Arquiteto Nildo Ribeiro da Rocha, 5456 - Jardim Iguaçú, Maringá - PR';

                // Função auxiliar para obter o número da semana
                function getWeekNumber(date) {
                    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                    const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                }
                
                // Verificar se é função de microfone ou leitor para personalizar a mensagem
                let message = '';
                
                if (designationFunction.includes('Microfone') || designationFunction.includes('Leitor')) {
                    // Para microfones e leitores, buscar outras designações do mesmo irmão na mesma semana
                    // Obter a semana da designação atual
                    const currentWeek = getWeekNumber(new Date(designation.data));
                    
                    // Buscar outras designações do mesmo irmão na mesma semana e mesma função
                    const otherDesignations = designations.filter(d => {
                        if (d.id === designation.id) return false; // Excluir a designação atual
                        if (d.irmao_id !== designation.irmao_id) return false; // Mesmo irmão
                        
                        // Verificar se é a mesma função ou grupo de função (microfones ou leitores)
                        const isSameFunction = 
                            (designationFunction.includes('Microfone') && d.funcao.includes('Microfone')) ||
                            (designationFunction.includes('Leitor') && d.funcao.includes('Leitor'));
                        
                        if (!isSameFunction) return false;
                        
                        // Verificar se é na mesma semana
                        const otherWeek = getWeekNumber(new Date(d.data + "T00:00:00"));
                        return otherWeek === currentWeek;
                    });
                    
                    if (otherDesignations.length > 0) {
                        // Tem múltiplas designações na mesma semana
                        const allDates = [designation, ...otherDesignations]
                            .sort((a, b) => new Date(a.data + "T00:00:00") - new Date(b.data + "T00:00:00"))
                            .map(d => formatDate(d.data));
                        
                        // Determinar o tipo de função genérico (Microfone ou Leitor)
                        const genericFunction = designationFunction.includes('Microfone') ? 'Microfone' : 'Leitor';
                        
                        message = `Olá, irmão *${brotherName}*! Tudo bem?\n\n` +
                                  `Gostaria de confirmar com você a seguinte designação:\n\n` +
                                  `📆 Datas: ${allDates.join(' e ')}\n` +
                                  `🎙️ Função: *${genericFunction}*\n` +
                                  `🕡 Horário: *${meetingTime}*\n\n` +
                                  `Agradecemos muito sua disposição! Qualquer dúvida, estou à disposição.\n\n` +
                                  `Um abraço fraterno! 🤝`;
                    } else {
                        // Apenas uma designação
                        message = `Olá, irmão *${brotherName}*! Tudo bem?\n\n` +
                                  `Gostaria de confirmar com você a seguinte designação:\n\n` +
                                  `📆 Data: *${formattedDate}*\n` +
                                  `🎙️ Função: *${designationFunction}*\n` +
                                  `🕡 Horário: *${meetingTime}*\n\n` +
                                  `Agradecemos muito sua disposição! Qualquer dúvida, estou à disposição.\n\n` +
                                  `Um abraço fraterno! 🤝`;
                    }
                } else {
                    // Para outras funções, usar o modelo padrão
                    message = `Olá, irmão *${brotherName}*! Tudo bem?\n\n` +
                              `Gostaria de confirmar com você a seguinte designação:\n\n` +
                              `📆 Data: *${formattedDate}*\n` +
                              `🎙️ Função: *${designationFunction}*\n` +
                              `🕡 Horário: *${meetingTime}*\n\n` +
                              `Agradecemos muito sua disposição! Qualquer dúvida, estou à disposição.\n\n` +
                              `Um abraço fraterno! 🤝`;
                }

                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${formattedPhoneNumber}?text=${encodedMessage}`;

                console.log('Abrindo URL do WhatsApp:', whatsappUrl);
                window.open(whatsappUrl, '_blank');
                showToast(`Mensagem para ${brotherName} aberta no WhatsApp.`, 'success');

            } catch (error) {
                console.error('Erro ao enviar designação via WhatsApp:', error);
                showToast('Erro ao preparar mensagem do WhatsApp: ' + error.message, 'error');
            }
        }
    </script>
<script>
// UTILIDADES DE TESTES
function agruparPorSemana(designacoes, funcao) {
    const semanas = {};
    designacoes.filter(d => d.funcao.includes(funcao)).forEach(d => {
        const data = new Date(d.data);
        const semana = data.getFullYear() + "-W" + getWeekNumber(data);
        if (!semanas[semana]) semanas[semana] = [];
        semanas[semana].push(d);
    });

    return Object.values(semanas)
        .filter(arr => arr.length >= 2)
        .map(semana => {
            const quinta = semana.find(d => new Date(d.data).getDay() === 4);
            const domingo = semana.find(d => new Date(d.data).getDay() === 0);
            if (!quinta || !domingo) return null;
            return { 
                quinta, 
                domingo,
                operadorQ: quinta.operador || quinta.irmao,
                ajudanteQ: quinta.ajudante || null,
                operadorD: domingo.operador || domingo.irmao,
                ajudanteD: domingo.ajudante || null
            };
        }).filter(Boolean);
}

function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

function agruparSemanasComLeitores(designacoes) {
    const leitores = designacoes.filter(d => 
        d.funcao.includes("Leitor") || d.funcao.includes("Sentinela")
    );

    const porSemana = {};
    leitores.forEach(d => {
        const data = new Date(d.data);
        const chave = data.getFullYear() + "-W" + getWeekNumber(data);
        if (!porSemana[chave]) porSemana[chave] = [];
        porSemana[chave].push(d);
    });

    return Object.values(porSemana);
}

// TESTES
function testSomInversao(designacoes) {
    const semanas = agruparPorSemana(designacoes, 'Som');
    return semanas.every(s => s.operadorQ === s.ajudanteD && s.ajudanteQ === s.operadorD);
}

function testFixasSemInversao(designacoes, funcao) {
    const semanas = agruparPorSemana(designacoes, funcao);
    return semanas.every(s => s.operadorQ === s.operadorD && s.ajudanteQ === s.ajudanteD);
}

function testLeitoresUnicos(designacoes) {
    const semanas = agruparSemanasComLeitores(designacoes);
    return semanas.every(semana => {
        const usados = new Set();
        return semana.every(d => {
            if (usados.has(d.irmao)) return false;
            usados.add(d.irmao);
            return true;
        });
    });
}

function executarTestesAutomatizados() {
    console.log("🧪 Testes Automáticos:");
    console.log("- Inversão SOM:", testSomInversao(designations));
    console.log("- Fixos Microfone:", testFixasSemInversao(designations, 'Microfone'));
    console.log("- Fixos Indicador:", testFixasSemInversao(designations, 'Indicador'));
    console.log("- Leitores únicos por semana:", testLeitoresUnicos(designations));
}
</script>
<script>
function getWeekKey(date) {
    const d = new Date(date);
    d.setDate(d.getDate() - (d.getDay() === 0 ? 6 : d.getDay() - 1));
    return `${d.getFullYear()}-W${getWeekNumber(d)}`;
}

function getWeekNumber(d) {
    const jan1 = new Date(d.getFullYear(), 0, 1);
    const days = Math.floor((d - jan1) / (24 * 60 * 60 * 1000));
    return Math.ceil((days + jan1.getDay() + 1) / 7);
}

function sortearMenorDesignacao(irmaos, funcaoAlvo, semanaKey, designacoesSemana) {
    const contagem = {};
    irmaos.forEach(i => contagem[i.id] = 0);
    designacoesSemana.forEach(des => {
        if (irmaos.map(i => i.id).includes(des.irmao_id)) {
            contagem[des.irmao_id]++;
        }
    });
    const minCount = Math.min(...Object.values(contagem));
    const candidatos = irmaos.filter(i => contagem[i.id] === minCount);
    return candidatos[Math.floor(Math.random() * candidatos.length)];
}

function gerarDatasEntre(inicio, fim, diasSemanaPermitidos = [0, 4]) {
    const datas = [];
    const atual = new Date(inicio);
    const dataFinal = new Date(fim);
    while (atual <= dataFinal) {
        if (diasSemanaPermitidos.includes(atual.getDay())) {
            datas.push(new Date(atual));
        }
        atual.setDate(atual.getDate() + 1);
    }
    return datas;
}

function escolherDuplaAleatoria(irmaos) {
    const embaralhados = irmaos.sort(() => 0.5 - Math.random());
    return embaralhados.slice(0, 2);
}

async function gerarDesignacoesAutomaticamente(startDate, endDate, selectedDays = [0,4], selectedFunctions = []) {
    const datas = gerarDatasEntre(startDate, endDate, selectedDays && selectedDays.length ? selectedDays : [0,4]);
    const novasDesignacoes = [];
    
    // Agrupar datas por semana
    const semanas = {};
    datas.forEach(data => {
        const semanaKey = getWeekKey(data);
        if (!semanas[semanaKey]) {
            semanas[semanaKey] = [];
        }
        semanas[semanaKey].push(data);
    });

    // Obter irmãos disponíveis por função
    const irmaosDisponiveis = brothers.filter(i => i.disponivel);
    
    // CORREÇÃO: Irmãos do som podem atuar em todas as funções que tiverem atribuídas
    const irmaosPorFuncao = {
        'Indicador': irmaosDisponiveis.filter(i => i.funcoes.includes('Indicador')),
        'Microfone': irmaosDisponiveis.filter(i => i.funcoes.includes('Microfone')),
        'Operador de Áudio': irmaosDisponiveis.filter(i => i.funcoes.includes('Operador de Áudio')),
        'Ajudante do Operador': irmaosDisponiveis.filter(i => i.funcoes.includes('Ajudante do Operador')),
        'Leitor Estudo Bíblico': irmaosDisponiveis.filter(i => i.funcoes.includes('Leitor Estudo Bíblico')),
        'Leitor Sentinela': irmaosDisponiveis.filter(i => i.funcoes.includes('Leitor Sentinela'))
    };

    console.log('Irmãos por função:', irmaosPorFuncao);

    // Contador global de designações por irmão
    const contadorGlobal = {};
    irmaosDisponiveis.forEach(irmao => {
        contadorGlobal[irmao.id] = designations.filter(d => d.irmao_id === irmao.id).length;
    });

    // Sistema de cooldown avançado - irmãos que participaram recentemente de cada função
    const cooldownPorFuncao = {
        'Som': new Map(), // Map<irmao_id, ultima_semana_designado>
        'Indicador': new Map(),
        'Microfone': new Map(),
        'Leitura': new Map()
    };
    // === Rastreamento GLOBAL de semanas servidas ===
    const lastWeekServed = new Map();          // Map<irmao_id, 'YYYY-Wnn'>
    const consecutiveWeeksServed = new Map();  // Map<irmao_id, count>
    const firstFuncGroupMonth = new Map(); // Map<irmao_id+monthKey, group>

    function weekDifference(weekA, weekB) {
        // ambas no formato YYYY-Wnn
        const [yA, wA] = weekA.split('-W').map(Number);
        const [yB, wB] = weekB.split('-W').map(Number);
        return (yB - yA) * 52 + (wB - wA);
    }

    function updateGlobalStreak(irmaoId, semanaKey) {
        const lastWeek = lastWeekServed.get(irmaoId);
        if (lastWeek && weekDifference(lastWeek, semanaKey) === 1) {
            consecutiveWeeksServed.set(irmaoId, (consecutiveWeeksServed.get(irmaoId) || 1) + 1);
        } else {
            consecutiveWeeksServed.set(irmaoId, 1);
        }
        lastWeekServed.set(irmaoId, semanaKey);
    }


    // CORREÇÃO: Cooldown mais inteligente - últimas 3 semanas para melhor distribuição
    const dataLimite = new Date();
    dataLimite.setDate(dataLimite.getDate() - 21); // 3 semanas atrás
    
    designations.forEach(d => {
        // Atualizar histórico global de semanas servidas
        updateGlobalStreak(d.irmao_id, getWeekKey(d.data));
        const dataDesignacao = new Date(d.data);
        if (dataDesignacao >= dataLimite) {
            if (d.funcao.includes('Operador') || d.funcao.includes('Ajudante')) {
                cooldownPorFuncao["Som"].set(d.irmao_id, new Date(d.data));
            } else if (d.funcao.includes('Indicador')) {
                cooldownPorFuncao["Indicador"].set(d.irmao_id, new Date(d.data));
            } else if (d.funcao.includes('Microfone')) {
                cooldownPorFuncao["Microfone"].set(d.irmao_id, new Date(d.data));
            } else if (d.funcao.includes('Leitor')) {
                cooldownPorFuncao["Leitura"].set(d.irmao_id, new Date(d.data));
            }
        }
    });

    console.log('Cooldown inicial:', cooldownPorFuncao);

    // CORREÇÃO: Função melhorada para selecionar irmão equilibrado com cooldown avançado
    
    // Função avançada para selecionar irmão levando em conta cooldown específico e descanso global
    function selecionarIrmaoComCooldown(candidatos, funcaoTipo, dataAtual = new Date(), excluir = []) {
        // Converte a data atual na chave da semana (ex.: 2025-W26)
        const semanaAtualKey = getWeekKey(dataAtual);

        const grupoDesejado = funcaoTipo;
        // 1. Remove candidatos em lista de exclusão
        let candidatosFiltrados = candidatos.filter(c => !excluir.includes(c.id));
        // NOVO: evitar repetir mesma função se for a segunda designação do mês
        candidatosFiltrados = candidatosFiltrados.filter(c => {
            const monthKey = getMonthKey(dataAtual);
            const key = `${c.id}-${monthKey}`;
            const firstGroup = firstFuncGroupMonth.get(key);
            if (!firstGroup) return true; // ainda não tem designação no mês
            if (firstGroup === grupoDesejado) return false; // já serviu nessa função primeiro
            return true;
        });

        // 2. Aplica regra de descanso global (precisa de 1 semana de folga após 3 seguidas)
        candidatosFiltrados = candidatosFiltrados.filter(c => {
            const lastWeek = lastWeekServed.get(c.id);
            const streak = consecutiveWeeksServed.get(c.id) || 0;
            if (!lastWeek) return true;                  // nunca designado
            const diff = weekDifference(lastWeek, semanaAtualKey);
            if (diff === 0) return false;                // já designado na mesma semana
            if (diff === 1 && streak >= 3) return false; // já serviu 2 semanas seguidas, precisa folga
            return true;
        });

        if (candidatosFiltrados.length === 0) return null;

        // 3. Aplica cooldown específico da função (7 dias)
        const mapaCooldown = cooldownPorFuncao[funcaoTipo] || new Map();
        const semCooldown = candidatosFiltrados.filter(c => {
            const ultima = mapaCooldown.get(c.id);
            if (!ultima) return true;
            const diffTime = Math.abs(dataAtual - ultima);
            const diffDays = Math.ceil(diffTime / 86400000);
            return diffDays > 7;
        });

        const candidatosValidos = semCooldown.length > 0 ? semCooldown : candidatosFiltrados;

        // 4. Ordena por menor número global de designações
        candidatosValidos.sort((a, b) => (contadorGlobal[a.id] || 0) - (contadorGlobal[b.id] || 0));
        const menor = contadorGlobal[candidatosValidos[0].id] || 0;
        const empatados = candidatosValidos.filter(c => (contadorGlobal[c.id] || 0) == menor);

        // 5. Seleciona aleatoriamente entre empatados
        const selecionado = empatados[Math.floor(Math.random() * empatados.length)];

        // 6. Atualiza rastreamento global de semanas consecutivas
        if (selecionado) {
            updateGlobalStreak(selecionado.id, semanaAtualKey);
        }

        return selecionado;
    }


    // Processar cada semana
    const semanasOrdenadas = Object.keys(semanas).sort();
    
    for (let i = 0; i < semanasOrdenadas.length; i++) {
        const semanaKey = semanasOrdenadas[i];
        const datasSemana = semanas[semanaKey];
        
        // Selecionar datas das reuniões dinamicamente
        const reuniao1 = datasSemana.find(d => d.getDay() === selectedDays[0]);
        const reuniao2 = datasSemana.find(d => d.getDay() === selectedDays[1]);
        const irmaosDia = { reuniao1: new Set(), reuniao2: new Set() };
        if (!reuniao1 || !reuniao2) continue;

        console.log(`\n=== Processando Semana ${semanaKey} ===`);

        
// Conjuntos para evitar acúmulo de funções no mesmo dia


        // Irmãos já usados nesta semana (para leitores)
        const irmaosSemana = new Set();

        // 1. SISTEMA DE SOM - COM INVERSÃO MELHORADA E COOLDOWN
        // CORREÇÃO: Permitir que irmãos do som também possam ser candidatos para outras funções
        const candidatosSom = irmaosPorFuncao['Operador de Áudio'].filter(i => 
            irmaosPorFuncao['Ajudante do Operador'].includes(i)
        );
        
        console.log('Candidatos Som:', candidatosSom.map(c => c.nome));
        console.log('Som em cooldown:', Array.from(cooldownPorFuncao['Som']).map(id => 
            brothers.find(b => b.id === id)?.nome
        ));
        
        if (candidatosSom.length >= 2) {
            const operadorReuniao1 = selecionarIrmaoComCooldown(candidatosSom, 'Som', reuniao1);
            const auxiliarReuniao1 = selecionarIrmaoComCooldown(candidatosSom, 'Som', reuniao1, [operadorReuniao1?.id]);
            
            if (operadorReuniao1 && auxiliarReuniao1) {
                // Reuniao1: Operador A, Auxiliar B
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Operador de Áudio',
                    irmao_id: operadorReuniao1.id
                });
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Ajudante do Operador',
                    irmao_id: auxiliarReuniao1.id
                });
                
                // Reuniao2: INVERSÃO - Operador B, Auxiliar A (rotação de duplas)
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Operador de Áudio',
                    irmao_id: auxiliarReuniao1.id
                });
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Ajudante do Operador',
                    irmao_id: operadorReuniao1.id
                });
                
                // Atualizar contadores e cooldown
                contadorGlobal[operadorReuniao1.id] = (contadorGlobal[operadorReuniao1.id] || 0) + 2;
                contadorGlobal[auxiliarReuniao1.id] = (contadorGlobal[auxiliarReuniao1.id] || 0) + 2;
                cooldownPorFuncao["Som"].set(operadorReuniao1.id, reuniao1);
                cooldownPorFuncao["Som"].set(auxiliarReuniao1.id, reuniao1);
                
                
// Atualizar conjuntos do dia para evitar acúmulo
irmaosDia.reuniao1.add(operadorReuniao1.id);
irmaosDia.reuniao1.add(auxiliarReuniao1.id);
irmaosDia.reuniao2.add(operadorReuniao1.id);
irmaosDia.reuniao2.add(auxiliarReuniao1.id);

                console.log(`Som: ${operadorReuniao1.nome} e ${auxiliarReuniao1.nome} (com inversão)`);
            }
        }

        // 2. INDICADORES - DUPLA FIXA NA SEMANA COM ROTAÇÃO ENTRE SEMANAS
        const candidatosIndicador = irmaosPorFuncao['Indicador'];
        console.log('Candidatos Indicador:', candidatosIndicador.map(c => c.nome));
        
        if (candidatosIndicador.length >= 2) {
            const indicador1 = selecionarIrmaoComCooldown(candidatosIndicador, 'Indicador', reuniao1);
            const indicador2 = selecionarIrmaoComCooldown(candidatosIndicador, 'Indicador', reuniao1, [indicador1?.id]);
            
            if (indicador1 && indicador2) {
                // Reuniao1
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Indicador Auditório',
                    irmao_id: indicador1.id
                });
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Indicador de Entrada',
                    irmao_id: indicador2.id
                });
                
                // Reuniao2 - MESMA DUPLA (dupla fixa na semana)
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Indicador Auditório',
                    irmao_id: indicador1.id
                });
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Indicador de Entrada',
                    irmao_id: indicador2.id
                });
                
                // Atualizar contadores e cooldown
                contadorGlobal[indicador1.id] = (contadorGlobal[indicador1.id] || 0) + 2;
                contadorGlobal[indicador2.id] = (contadorGlobal[indicador2.id] || 0) + 2;
                cooldownPorFuncao['Indicador'].set(indicador1.id, reuniao2);
                cooldownPorFuncao['Microfone'].set(indicador1.id, reuniao2);
                cooldownPorFuncao['Indicador'].set(indicador1.id, reuniao2);
                cooldownPorFuncao['Indicador'].set(indicador2.id, reuniao2);
                cooldownPorFuncao['Microfone'].set(indicador2.id, reuniao2);
                cooldownPorFuncao['Indicador'].set(indicador2.id, reuniao2);
                
                
// Atualizar conjuntos do dia
irmaosDia.reuniao1.add(indicador1.id);
irmaosDia.reuniao1.add(indicador2.id);
irmaosDia.reuniao2.add(indicador1.id);
irmaosDia.reuniao2.add(indicador2.id);

                console.log(`Indicadores: ${indicador1.nome} e ${indicador2.nome} (dupla fixa)`);
            }
        }

        // 3. MICROFONES - DUPLA FIXA NA SEMANA COM ROTAÇÃO ENTRE SEMANAS
        const candidatosMicrofone = irmaosPorFuncao['Microfone'];
        console.log('Candidatos Microfone:', candidatosMicrofone.map(c => c.nome));
        
        if (candidatosMicrofone.length >= 2) {
            const microfone1 = selecionarIrmaoComCooldown(candidatosMicrofone, 'Microfone', reuniao1);
            const microfone2 = selecionarIrmaoComCooldown(candidatosMicrofone, 'Microfone', reuniao1, [microfone1?.id]);
            
            if (microfone1 && microfone2) {
                // Reuniao1
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Microfone 1',
                    irmao_id: microfone1.id
                });
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Microfone 2',
                    irmao_id: microfone2.id
                });
                
                // Reuniao2 - MESMA DUPLA (dupla fixa na semana)
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Microfone 1',
                    irmao_id: microfone1.id
                });
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Microfone 2',
                    irmao_id: microfone2.id
                });
                
                // Atualizar contadores e cooldown
                contadorGlobal[microfone1.id] = (contadorGlobal[microfone1.id] || 0) + 2;
                contadorGlobal[microfone2.id] = (contadorGlobal[microfone2.id] || 0) + 2;
                cooldownPorFuncao['Microfone'].set(microfone1.id, reuniao2);
                cooldownPorFuncao['Indicador'].set(microfone1.id, reuniao2);
                cooldownPorFuncao['Microfone'].set(microfone2.id, reuniao2);
                cooldownPorFuncao['Indicador'].set(microfone2.id, reuniao2);
                
                
// Atualizar conjuntos do dia
irmaosDia.reuniao1.add(microfone1.id);
irmaosDia.reuniao1.add(microfone2.id);
irmaosDia.reuniao2.add(microfone1.id);
irmaosDia.reuniao2.add(microfone2.id);

                console.log(`Microfones: ${microfone1.nome} e ${microfone2.nome} (dupla fixa)`);
            }
        }

        // 4. LEITORES - ÚNICOS POR SEMANA COM COOLDOWN MELHORADO

        // Excluir irmãos que já têm designação na reuniao1
        const excluiReuniao1 = Array.from(irmaosDia.reuniao1);
        const excluiReuniao2 = Array.from(irmaosDia.reuniao2);
        // CORREÇÃO: Todos os irmãos podem ser leitores se tiverem a função atribuída
        
        // Leitor Estudo Bíblico - Reuniao1
        const candidatosEB = irmaosPorFuncao['Leitor Estudo Bíblico'].filter(i => !irmaosSemana.has(i.id));
        console.log('Candidatos Estudo Bíblico:', candidatosEB.map(c => c.nome));
        
        if (candidatosEB.length > 0) {
            const leitorEB = selecionarIrmaoComCooldown(candidatosEB, 'Leitura');
            if (leitorEB) {
                novasDesignacoes.push({
                    data: reuniao1.toISOString().split('T')[0],
                    funcao: 'Leitor Estudo Bíblico',
                    irmao_id: leitorEB.id
                });
                irmaosSemana.add(leitorEB.id);
                contadorGlobal[leitorEB.id] = (contadorGlobal[leitorEB.id] || 0) + 1;
                cooldownPorFuncao['Leitura'].set(leitorEB.id, reuniao1);
                irmaosDia.reuniao1.add(leitorEB.id);
                console.log(`Leitor EB: ${leitorEB.nome}`);
            }
        }

        // Leitor Sentinela - Reuniao2
        const candidatosSentinela = irmaosPorFuncao['Leitor Sentinela'].filter(i => !irmaosSemana.has(i.id));
        console.log('Candidatos Sentinela:', candidatosSentinela.map(c => c.nome));
        
        if (candidatosSentinela.length > 0) {
            const leitorSentinela = selecionarIrmaoComCooldown(candidatosSentinela, 'Leitura');
            if (leitorSentinela) {
                novasDesignacoes.push({
                    data: reuniao2.toISOString().split('T')[0],
                    funcao: 'Leitor Sentinela',
                    irmao_id: leitorSentinela.id
                });
                irmaosSemana.add(leitorSentinela.id);
                contadorGlobal[leitorSentinela.id] = (contadorGlobal[leitorSentinela.id] || 0) + 1;
                cooldownPorFuncao['Leitura'].set(leitorSentinela.id, reuniao2);
                irmaosDia.reuniao2.add(leitorSentinela.id);
                console.log(`Leitor Sentinela: ${leitorSentinela.nome}`);
            }
        }
    }

    console.log("📋 Designações Geradas com Rodízio Inteligente:", novasDesignacoes);
    console.log("📊 Contador final:", contadorGlobal);
    return novasDesignacoes;
}
</script>
</div>
<div class="modal-overlay" id="whatsapp-modal">
<div class="modal">
<div class="modal-header" style="background: linear-gradient(135deg, #25D366, #128C7E); color:white;">
<h3><i class="fab fa-whatsapp"></i> Enviar Designações via WhatsApp</h3>
<button class="modal-close">Cancelar</button>
</div>
<div class="modal-body">
<div class="form-group">
<label for="whatsapp-brother">Selecione o irmão:</label>
<select id="whatsapp-brother"></select>
</div>
<div class="form-group">
<label for="whatsapp-month">Selecione o mês:</label>
<select id="whatsapp-month">
<option value="">Escolha um mês...</option>
<option value="0">Janeiro</option>
<option value="1">Fevereiro</option>
<option value="2">Março</option>
<option value="3">Abril</option>
<option value="4">Maio</option>
<option value="5">Junho</option>
<option value="6">Julho</option>
<option value="7">Agosto</option>
<option value="8">Setembro</option>
<option value="9">Outubro</option>
<option value="10">Novembro</option>
<option value="11">Dezembro</option>
</select>
</div>
<div class="form-group">
<label for="whatsapp-preview">Prévia da mensagem:</label>
<textarea class="form-control" id="whatsapp-preview" rows="6" style="width: 100%; resize: vertical;"></textarea>
</div>
<div class="form-group" style="text-align:right;">
<button class="btn btn-success" id="btn-open-whatsapp">
<i class="fab fa-whatsapp"></i> Abrir WhatsApp
        </button>
</div>
</div>
</div>
</div>
<script>
function generateMessagePreview(brotherId, month) {
    if (!brotherId || month === "") return;

    const brother = brothers.find(b => b.id == brotherId);
    if (!brother) return;

    const brotherDesignations = designations.filter(designation => {
        const designationDate = new Date(designation.data + 'T00:00:00');
        const designationMonth = designationDate.getMonth();
        return designation.irmao_id == brotherId && designationMonth == month;
    }).sort((a, b) => new Date(a.data + 'T00:00:00') - new Date(b.data + 'T00:00:00'));

    let message = `Olá, irmão *${brother.nome}*!\nEspero que esteja tudo bem com você e sua família. Seguem abaixo suas designações no Salão do Reino para este mês:\n\n`;

    if (brotherDesignations.length === 0) {
        message += "❌ Nenhuma designação neste mês.";
    } else {
        brotherDesignations.forEach(item => {
            const date = new Date(item.data + 'T00:00:00');
            const dateFormatted = date.toLocaleDateString('pt-BR');
            message += `📅 *${dateFormatted}* – ${getFunctionEmoji(item.funcao)} *${item.funcao}*
`;
        });
    }

    message += "\nQualquer dúvida ou imprevisto, por favor, me avise o quanto antes, tá bom?\n\nDesde já, muito obrigado por sua disposição em servir!\n\nForte abraço!";
    document.getElementById('whatsapp-preview').value = message;
}

function populateWhatsAppBrothers() {
    const select = document.getElementById('whatsapp-brother');
    select.innerHTML = '<option value="">Escolha um irmão...</option>';
    brothers.forEach(brother => {
        const option = document.createElement('option');
        option.value = brother.id;
        option.textContent = brother.nome;
        select.appendChild(option);
    });
}

function getMonthName(monthIndex) {
    const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    return months[monthIndex];
}

document.getElementById('btn-whatsapp').addEventListener('click', () => {
    document.getElementById('whatsapp-modal').classList.add('active');
    populateWhatsAppBrothers();

    setTimeout(() => {
        const brotherId = document.getElementById('whatsapp-brother').value;
        const month = document.getElementById('whatsapp-month').value;
        generateMessagePreview(brotherId, month);
    }, 100);
});

document.querySelectorAll('#whatsapp-modal .modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('whatsapp-modal').classList.remove('active');
    });
});

document.getElementById('whatsapp-brother').addEventListener('change', () => {
    const brotherId = document.getElementById('whatsapp-brother').value;
    const month = document.getElementById('whatsapp-month').value;
    generateMessagePreview(brotherId, month);
});

document.getElementById('whatsapp-month').addEventListener('change', () => {
    const brotherId = document.getElementById('whatsapp-brother').value;
    const month = document.getElementById('whatsapp-month').value;
    generateMessagePreview(brotherId, month);
});
</script><script>
document.getElementById('btn-open-whatsapp').addEventListener('click', async () => {
    const previewText = document.getElementById('whatsapp-preview').value.trim();
    const brotherId = document.getElementById('whatsapp-brother').value;
    const month = document.getElementById('whatsapp-month').value;

    if (!brotherId || !previewText || month === "") {
        showToast("Preencha o irmão, o mês e a mensagem.", "warning");
        return;
    }

    const brother = brothers.find(b => b.id == brotherId);
    if (!brother) {
        showToast("Irmão não encontrado.", "error");
        return;
    }

    const phoneNumber = brother.telefone ? brother.telefone.replace(/\D/g, '') : "";
    if (!phoneNumber) {
        showToast("O irmão não tem telefone cadastrado.", "error");
        return;
    }

    const whatsappLink = `https://wa.me/55${phoneNumber}?text=${encodeURIComponent(previewText)}`;
    window.open(whatsappLink, '_blank');

    // Atualiza no banco as designações do irmão no mês
    const designacoesFiltradas = designations.filter(designation => {
        const data = new Date(designation.data + 'T00:00:00');
        const dataMonth = data.getMonth();
        return designation.irmao_id == brotherId && dataMonth == month;
    });

    const idsParaAtualizar = designacoesFiltradas.map(d => d.id);
    if (idsParaAtualizar.length > 0) {
        const { error } = await supabaseClient
            .from('designacoes_final')
            .update({ enviado_whatsapp_em: new Date().toISOString() })
            .in('id', idsParaAtualizar);

        if (error) {
            console.error("Erro ao atualizar data de envio:", error);
            showToast("Erro ao salvar histórico de envio.", "error");
        } else {
            console.log("Designações marcadas como enviadas com sucesso.");
        }
    }
});
</script>
<script>
function getEmojiPorFuncao(funcao) {
    const nome = funcao.toLowerCase().trim().normalize("NFD").replace(/[̀-ͯ]/g, "");

    if (nome.includes('microfone')) return '🎤';
    if (nome.includes('operador') && nome.includes('audio')) return '🎧';
    if (nome.includes('ajudante')) return '🧑‍🔧';
    if (nome.includes('indicador')) return '🧍';
    if (nome.includes('sentinela')) return '📘';
    if (nome.includes('estudo')) return '📘';
    return '📌';
}

function atualizarPreviaMensagem() {
    const irmaoSelecionado = document.getElementById('selectIrmao').value;
    const mesSelecionado = parseInt(document.getElementById('selectMesGrid')?.value || 0);

    if (!irmaoSelecionado || mesSelecionado === 0) {
        document.getElementById('mensagemPreview').value = '';
        return;
    }

    const designacoesFiltradas = designacoes.filter(d => {
        const nomeMatch = (d.irmao || d.nome_irmao || '').trim() === irmaoSelecionado.trim();
        const data = new Date(d.data + 'T00:00:00');
        const mes = data.getMonth() + 1;
        return nomeMatch && mes === mesSelecionado;
    });

    if (designacoesFiltradas.length === 0) {
        document.getElementById('mensagemPreview').value = '';
        return;
    }

    const saudacao = `Olá, irmão ${irmaoSelecionado.split(' ')[0]}!
Espero que esteja tudo bem com você e sua família.`;
    const titulo = `

📅 Seguem abaixo suas designações no Salão do Reino para este mês:`;

    const listaFormatada = designacoesFiltradas.map(d => {
        const dataObj = new Date(d.data + 'T00:00:00');
        const dia = String(dataObj.getDate()).padStart(2, '0');
        const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
        const ano = dataObj.getFullYear();
        const dataFormatada = `${dia}/${mes}/${ano}`;
        const emojiFuncao = getEmojiPorFuncao(d.funcao);
        return `  📅 *${dataFormatada}* – ${emojiFuncao} *${d.funcao.trim()}*`;
        }).join(`\n`);
');

    const rodape = `

Qualquer dúvida ou imprevisto, por favor, me avise o quanto antes, tá bom?
Muito obrigado por sua disposição em servir!

Forte abraço!`;

    const mensagemFinal = `${saudacao}${titulo}
${listaFormatada}${rodape}`;
    document.getElementById('mensagemPreview').value = mensagemFinal;
}
</script>
<script>
document.getElementById("btn-save-designation").addEventListener("click", async function () {
    const id = document.getElementById("designation-id").value;
    const data = document.getElementById("designation-date").value;
    const funcao = document.getElementById("designation-function").value;
    const irmao_id = document.getElementById("designation-brother").value;
    const observacoes = document.getElementById("designation-observations").value || null;
    const notificacao = document.getElementById("designation-notificacao").checked;

    if (!data || !funcao || !irmao_id) {
        showToast("Por favor, preencha todos os campos obrigatórios.", "warning");
        return;
    }

    const payload = {
        data,
        funcao,
        irmao_id,
        observacoes,
        notificacao
    };

    let result;

    if (id) {
        result = await supabase
            .from("designacoes_final")
            .update(payload)
            .eq("id", id);
    } else {
        result = await supabase
            .from("designacoes_final")
            .insert([payload]);
    }

    if (result.error) {
        console.error(result.error);
        showToast(`Erro ao salvar designação: ${result.error.message}`, "error");
    } else {
        showToast("Designação salva com sucesso!");
        document.querySelector("#designation-modal .modal-close").click();
        carregarDesignacoes();
    }
});
</script></body>
</html>
